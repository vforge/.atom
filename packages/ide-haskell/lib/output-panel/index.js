"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = { fileFilter: false, activeTab: 'error' }) {
        this.state = state;
        this.elements = new Set();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.statusMap = new Map();
        this.progress = [];
        this.tabs = new Map();
        this.switchFileFilter = () => {
            this.state.fileFilter = !this.state.fileFilter;
            this.updateItems();
        };
        etch.initialize(this);
        for (const tab of ['error', 'warning', 'lint']) {
            this.createTab(tab, {});
        }
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.state.fileFilter)
                this.updateItems();
        }));
        setImmediate(async () => {
            await this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        });
    }
    connectResults(results) {
        if (this.results)
            throw new Error('Results already connected!');
        this.results = results;
        let lastUpdateTime = Date.now();
        let collectedSeverities = new Set();
        const didUpdate = (severities) => {
            this.currentResult = 0;
            this.updateItems();
            const newUpdateTime = Date.now();
            if (newUpdateTime - lastUpdateTime <
                atom.config.get('ide-haskell.switchTabOnCheckInterval')) {
                for (const s of severities) {
                    collectedSeverities.add(s);
                }
            }
            else {
                collectedSeverities = new Set(severities);
            }
            if (atom.config.get('ide-haskell.autoHideOutput') &&
                (!this.results || this.results.isEmpty(severities))) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab(collectedSeverities);
            }
            lastUpdateTime = newUpdateTime;
        };
        this.disposables.add(this.results.onDidUpdate(didUpdate));
        this.update();
    }
    render() {
        if (!this.results) {
            return etch.dom("ide-haskell-panel", null);
        }
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { buttons: Array.from(this.tabs.values()), activeBtn: this.state.activeTab }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { class: "ide-haskell-checkbox--uri-filter", state: this.state.fileFilter || false, onSwitched: this.switchFileFilter, enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter, ref: "items" })));
    }
    async update() {
        return etch.update(this);
    }
    destroy() {
        this.hide();
    }
    async reallyDestroy() {
        await etch.destroy(this);
        this.disposables.dispose();
    }
    async toggle() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (!pane || (utils_1.isDock(pane) && !pane.isVisible())) {
            return this.show();
        }
        else {
            return this.hide();
        }
    }
    async show() {
        await atom.workspace.open(this, {
            searchAllPanes: true,
            activatePane: false,
        });
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            pane.show();
        }
    }
    hide() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            atom.workspace.hide(this);
        }
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getURI() {
        return `ide-haskell://output-panel/`;
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            this.update();
        });
    }
    async updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (this.state.fileFilter) {
            const ed = atom.workspace.getActiveTextEditor();
            currentUri = ed ? ed.getPath() : undefined;
        }
        let scroll = false;
        if (activeTab) {
            const ato = this.tabs.get(activeTab);
            if (currentUri !== undefined && ato && ato.uriFilter) {
                this.itemFilter = ({ uri, severity }) => severity === activeTab && uri === currentUri;
            }
            else {
                this.itemFilter = ({ severity }) => severity === activeTab;
            }
            scroll =
                (ato && ato.autoScroll && this.refs.items && this.refs.items.atEnd()) ||
                    false;
        }
        if (this.results) {
            for (const [btn, ato] of this.tabs.entries()) {
                ato.count = Array.from(this.results.filter(({ severity }) => severity === btn)).length;
            }
        }
        await this.update();
        if (scroll && this.refs.items)
            await this.refs.items.scrollToEnd();
    }
    activateTab(tab) {
        this.state.activeTab = tab;
        this.updateItems();
    }
    activateFirstNonEmptyTab(severities) {
        for (const tab of this.tabs.values()) {
            if (!severities.has(tab.name))
                continue;
            const count = tab.count;
            if (count && count > 0) {
                this.show();
                this.activateTab(tab.name);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        if (this.refs.items)
            this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.state.activeTab;
    }
    async createTab(name, { uriFilter = true, autoScroll = false }) {
        if (['error', 'warning', 'lint'].includes(name) &&
            atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        if (!Array.from(this.tabs.keys()).includes(name)) {
            this.tabs.set(name, {
                name,
                count: 0,
                onClick: () => this.activateTab(name),
                uriFilter,
                autoScroll,
            });
            if (this.state.activeTab)
                this.activateTab(this.state.activeTab);
        }
        return this.update();
    }
    serialize() {
        return Object.assign({}, this.state, { deserializer: 'ide-haskell/OutputPanel' });
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress = Array.from(this.statusMap.values()).reduce((cv, i) => {
            if (i.status === 'progress' && i.progress !== undefined) {
                cv.push(i.progress);
            }
            return cv;
        }, []);
        this.update();
    }
    showNextError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => uri !== undefined));
        if (rs.length === 0) {
            return;
        }
        this.currentResult++;
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => uri !== undefined));
        if (rs.length === 0) {
            return;
        }
        this.currentResult--;
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE0QjtBQUM1QiwrQkFBc0Q7QUFDdEQsdUVBQTJFO0FBQzNFLHlFQUFtRTtBQUNuRSx1REFBa0Q7QUFDbEQsbUVBQTZEO0FBRTdELHFEQUFnRDtBQUNoRCxvQ0FBcUQ7QUFFckQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQVNsQjtJQWFFLFlBQ1UsUUFBZ0IsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUU7UUFBekQsVUFBSyxHQUFMLEtBQUssQ0FBb0Q7UUFUM0QsYUFBUSxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQ3RDLGdCQUFXLEdBQXdCLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1RCxrQkFBYSxHQUFXLENBQUMsQ0FBQTtRQUN6QixjQUFTLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUE7UUFDL0MsYUFBUSxHQUFhLEVBQUUsQ0FBQTtRQUN2QixTQUFJLEdBQTBCLElBQUksR0FBRyxFQUFFLENBQUE7UUFnVXZDLHFCQUFnQixHQUFHLEdBQUcsRUFBRTtZQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFBO1lBRTlDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtRQUNwQixDQUFDLENBQUE7UUE5VEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVyQixHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRS9DLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ3pCLENBQUM7UUFF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QUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBQ3BDLENBQUM7UUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0NBT0Y7QUEvVUQsa0NBK1VDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXRjaCBmcm9tICdldGNoJ1xuaW1wb3J0IHsgRGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJQnRuRGVzYywgT3V0cHV0UGFuZWxCdXR0b25zIH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtYnV0dG9ucydcbmltcG9ydCB7IE91dHB1dFBhbmVsQ2hlY2tib3ggfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1jaGVja2JveCdcbmltcG9ydCB7IFByb2dyZXNzQmFyIH0gZnJvbSAnLi92aWV3cy9wcm9ncmVzcy1iYXInXG5pbXBvcnQgeyBPdXRwdXRQYW5lbEl0ZW1zIH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtaXRlbXMnXG5pbXBvcnQgeyBSZXN1bHRzREIsIFJlc3VsdEl0ZW0gfSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHsgU3RhdHVzSWNvbiB9IGZyb20gJy4vdmlld3Mvc3RhdHVzLWljb24nXG5pbXBvcnQgeyBpc0RvY2ssIGlzU2ltcGxlQ29udHJvbERlZiB9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5jb25zdCAkID0gZXRjaC5kb21cblxuZXhwb3J0IGludGVyZmFjZSBJU3RhdGUge1xuICBmaWxlRmlsdGVyOiBib29sZWFuXG4gIGFjdGl2ZVRhYjogc3RyaW5nXG59XG5cbmV4cG9ydCB0eXBlIFRQYW5lbFBvc2l0aW9uID0gJ2JvdHRvbScgfCAnbGVmdCcgfCAndG9wJyB8ICdyaWdodCdcblxuZXhwb3J0IGNsYXNzIE91dHB1dFBhbmVsIHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuaW5pdGlhbGl6ZWRcbiAgcHJpdmF0ZSByZWZzOiB7XG4gICAgaXRlbXM/OiBPdXRwdXRQYW5lbEl0ZW1zXG4gIH1cbiAgcHJpdmF0ZSBlbGVtZW50czogU2V0PEpTWC5FbGVtZW50PiA9IG5ldyBTZXQoKVxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIGN1cnJlbnRSZXN1bHQ6IG51bWJlciA9IDBcbiAgcHJpdmF0ZSBzdGF0dXNNYXA6IE1hcDxzdHJpbmcsIFVQSS5JU3RhdHVzPiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIHByb2dyZXNzOiBudW1iZXJbXSA9IFtdXG4gIHByaXZhdGUgdGFiczogTWFwPHN0cmluZywgSUJ0bkRlc2M+ID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgaXRlbUZpbHRlcj86IChpdGVtOiBSZXN1bHRJdGVtKSA9PiBib29sZWFuXG4gIHByaXZhdGUgcmVzdWx0cz86IFJlc3VsdHNEQlxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHN0YXRlOiBJU3RhdGUgPSB7IGZpbGVGaWx0ZXI6IGZhbHNlLCBhY3RpdmVUYWI6ICdlcnJvcicgfSxcbiAgKSB7XG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICBmb3IgKGNvbnN0IHRhYiBvZiBbJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCddKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIHRoaXMuY3JlYXRlVGFiKHRhYiwge30pXG4gICAgfVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vbkRpZENoYW5nZUFjdGl2ZVBhbmVJdGVtKCgpID0+IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmZpbGVGaWx0ZXIpIHRoaXMudXBkYXRlSXRlbXMoKVxuICAgICAgfSksXG4gICAgKVxuICAgIHNldEltbWVkaWF0ZShhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLnNob3coKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgY29ubmVjdFJlc3VsdHMocmVzdWx0czogUmVzdWx0c0RCKSB7XG4gICAgaWYgKHRoaXMucmVzdWx0cykgdGhyb3cgbmV3IEVycm9yKCdSZXN1bHRzIGFscmVhZHkgY29ubmVjdGVkIScpXG4gICAgdGhpcy5yZXN1bHRzID0gcmVzdWx0c1xuXG4gICAgbGV0IGxhc3RVcGRhdGVUaW1lID0gRGF0ZS5ub3coKVxuICAgIGxldCBjb2xsZWN0ZWRTZXZlcml0aWVzID0gbmV3IFNldDxVUEkuVFNldmVyaXR5PigpXG4gICAgY29uc3QgZGlkVXBkYXRlID0gKHNldmVyaXRpZXM6IFVQSS5UU2V2ZXJpdHlbXSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgICAgIGNvbnN0IG5ld1VwZGF0ZVRpbWUgPSBEYXRlLm5vdygpXG4gICAgICBpZiAoXG4gICAgICAgIG5ld1VwZGF0ZVRpbWUgLSBsYXN0VXBkYXRlVGltZSA8XG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuc3dpdGNoVGFiT25DaGVja0ludGVydmFsJylcbiAgICAgICkge1xuICAgICAgICBmb3IgKGNvbnN0IHMgb2Ygc2V2ZXJpdGllcykge1xuICAgICAgICAgIGNvbGxlY3RlZFNldmVyaXRpZXMuYWRkKHMpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbGxlY3RlZFNldmVyaXRpZXMgPSBuZXcgU2V0KHNldmVyaXRpZXMpXG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJlxuICAgICAgICAoIXRoaXMucmVzdWx0cyB8fCB0aGlzLnJlc3VsdHMuaXNFbXB0eShzZXZlcml0aWVzKSlcbiAgICAgICkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfSBlbHNlIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN3aXRjaFRhYk9uQ2hlY2snKSkge1xuICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYihjb2xsZWN0ZWRTZXZlcml0aWVzKVxuICAgICAgfVxuICAgICAgbGFzdFVwZGF0ZVRpbWUgPSBuZXdVcGRhdGVUaW1lXG4gICAgfVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5yZXN1bHRzLm9uRGlkVXBkYXRlKGRpZFVwZGF0ZSkpXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIHJlbmRlcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcbiAgICAgIHJldHVybiA8aWRlLWhhc2tlbGwtcGFuZWwgLz5cbiAgICB9XG4gICAgcmV0dXJuIChcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlOm5vLXVuc2FmZS1hbnlcbiAgICAgIDxpZGUtaGFza2VsbC1wYW5lbD5cbiAgICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsLWhlYWRpbmc+XG4gICAgICAgICAgPFN0YXR1c0ljb24gc3RhdHVzTWFwPXt0aGlzLnN0YXR1c01hcH0gLz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxCdXR0b25zXG4gICAgICAgICAgICBidXR0b25zPXtBcnJheS5mcm9tKHRoaXMudGFicy52YWx1ZXMoKSl9XG4gICAgICAgICAgICBhY3RpdmVCdG49e3RoaXMuc3RhdGUuYWN0aXZlVGFifVxuICAgICAgICAgIC8+XG4gICAgICAgICAgPE91dHB1dFBhbmVsQ2hlY2tib3hcbiAgICAgICAgICAgIGNsYXNzPVwiaWRlLWhhc2tlbGwtY2hlY2tib3gtLXVyaS1maWx0ZXJcIlxuICAgICAgICAgICAgc3RhdGU9e3RoaXMuc3RhdGUuZmlsZUZpbHRlciB8fCBmYWxzZX1cbiAgICAgICAgICAgIG9uU3dpdGNoZWQ9e3RoaXMuc3dpdGNoRmlsZUZpbHRlcn1cbiAgICAgICAgICAgIGVuYWJsZWRIaW50PVwiU2hvdyBjdXJyZW50IGZpbGUgbWVzc2FnZXNcIlxuICAgICAgICAgICAgZGlzYWJsZWRIaW50PVwiU2hvdyBhbGwgcHJvamVjdCBtZXNzYWdlc1wiXG4gICAgICAgICAgLz5cbiAgICAgICAgICB7QXJyYXkuZnJvbSh0aGlzLmVsZW1lbnRzLnZhbHVlcygpKX1cbiAgICAgICAgICA8UHJvZ3Jlc3NCYXIgcHJvZ3Jlc3M9e3RoaXMucHJvZ3Jlc3N9IC8+XG4gICAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgPE91dHB1dFBhbmVsSXRlbXNcbiAgICAgICAgICBtb2RlbD17dGhpcy5yZXN1bHRzfVxuICAgICAgICAgIGZpbHRlcj17dGhpcy5pdGVtRmlsdGVyfVxuICAgICAgICAgIHJlZj1cIml0ZW1zXCJcbiAgICAgICAgLz5cbiAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgICAvLyB0c2xpbnQ6ZW5hYmxlOm5vLXVuc2FmZS1hbnlcbiAgICApXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5oaWRlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95KCkge1xuICAgIGF3YWl0IGV0Y2guZGVzdHJveSh0aGlzKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdG9nZ2xlKCkge1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmICghcGFuZSB8fCAoaXNEb2NrKHBhbmUpICYmICFwYW5lLmlzVmlzaWJsZSgpKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc2hvdygpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmhpZGUoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93KCkge1xuICAgIGF3YWl0IGF0b20ud29ya3NwYWNlLm9wZW4odGhpcywge1xuICAgICAgc2VhcmNoQWxsUGFuZXM6IHRydWUsXG4gICAgICBhY3RpdmF0ZVBhbmU6IGZhbHNlLFxuICAgIH0pXG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKHBhbmUgJiYgaXNEb2NrKHBhbmUpKSB7XG4gICAgICBwYW5lLnNob3coKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBoaWRlKCkge1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmIChwYW5lICYmIGlzRG9jayhwYW5lKSkge1xuICAgICAgYXRvbS53b3Jrc3BhY2UuaGlkZSh0aGlzKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSgpIHtcbiAgICByZXR1cm4gJ0lERS1IYXNrZWxsJ1xuICB9XG5cbiAgcHVibGljIGdldFVSSSgpIHtcbiAgICByZXR1cm4gYGlkZS1oYXNrZWxsOi8vb3V0cHV0LXBhbmVsL2BcbiAgfVxuXG4gIHB1YmxpYyBnZXREZWZhdWx0TG9jYXRpb24oKSB7XG4gICAgcmV0dXJuIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwucGFuZWxQb3NpdGlvbicpXG4gIH1cblxuICBwdWJsaWMgYWRkUGFuZWxDb250cm9sPFQ+KGRlZjogVVBJLlRDb250cm9sRGVmaW5pdGlvbjxUPikge1xuICAgIGxldCBuZXdFbGVtZW50OiBKU1guRWxlbWVudFxuICAgIGlmIChpc1NpbXBsZUNvbnRyb2xEZWYoZGVmKSkge1xuICAgICAgY29uc3QgeyBldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRycyB9ID0gZGVmLm9wdHNcbiAgICAgIGNvbnN0IHByb3BzOiB7IFtrZXk6IHN0cmluZ106IE9iamVjdCB9ID0ge31cbiAgICAgIGlmIChjbGFzc2VzKSB7XG4gICAgICAgIHByb3BzLmNsYXNzID0gY2xhc3Nlcy5qb2luKCcgJylcbiAgICAgIH1cbiAgICAgIGlmIChzdHlsZSkge1xuICAgICAgICBwcm9wcy5zdHlsZSA9IHN0eWxlXG4gICAgICB9XG4gICAgICBpZiAoYXR0cnMpIHtcbiAgICAgICAgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzXG4gICAgICB9XG4gICAgICBpZiAoZXZlbnRzKSB7XG4gICAgICAgIHByb3BzLm9uID0gZXZlbnRzXG4gICAgICB9XG5cbiAgICAgIG5ld0VsZW1lbnQgPSAkKGRlZi5lbGVtZW50LCBwcm9wcylcbiAgICB9IGVsc2Uge1xuICAgICAgbmV3RWxlbWVudCA9ICQoZGVmLmVsZW1lbnQsIGRlZi5vcHRzKVxuICAgIH1cbiAgICB0aGlzLmVsZW1lbnRzLmFkZChuZXdFbGVtZW50KVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMudXBkYXRlKClcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5lbGVtZW50cy5kZWxldGUobmV3RWxlbWVudClcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgdGhpcy51cGRhdGUoKVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlSXRlbXMoKSB7XG4gICAgY29uc3QgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCBjdXJyZW50VXJpOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICBpZiAodGhpcy5zdGF0ZS5maWxlRmlsdGVyKSB7XG4gICAgICBjb25zdCBlZCA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICAgICAgY3VycmVudFVyaSA9IGVkID8gZWQuZ2V0UGF0aCgpIDogdW5kZWZpbmVkXG4gICAgfVxuICAgIGxldCBzY3JvbGw6IGJvb2xlYW4gPSBmYWxzZVxuICAgIGlmIChhY3RpdmVUYWIpIHtcbiAgICAgIGNvbnN0IGF0byA9IHRoaXMudGFicy5nZXQoYWN0aXZlVGFiKVxuICAgICAgaWYgKGN1cnJlbnRVcmkgIT09IHVuZGVmaW5lZCAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikge1xuICAgICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoeyB1cmksIHNldmVyaXR5IH0pID0+XG4gICAgICAgICAgc2V2ZXJpdHkgPT09IGFjdGl2ZVRhYiAmJiB1cmkgPT09IGN1cnJlbnRVcmlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuaXRlbUZpbHRlciA9ICh7IHNldmVyaXR5IH0pID0+IHNldmVyaXR5ID09PSBhY3RpdmVUYWJcbiAgICAgIH1cbiAgICAgIHNjcm9sbCA9XG4gICAgICAgIChhdG8gJiYgYXRvLmF1dG9TY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zICYmIHRoaXMucmVmcy5pdGVtcy5hdEVuZCgpKSB8fFxuICAgICAgICBmYWxzZVxuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc3VsdHMpIHtcbiAgICAgIGZvciAoY29uc3QgW2J0biwgYXRvXSBvZiB0aGlzLnRhYnMuZW50cmllcygpKSB7XG4gICAgICAgIGF0by5jb3VudCA9IEFycmF5LmZyb20oXG4gICAgICAgICAgdGhpcy5yZXN1bHRzLmZpbHRlcigoeyBzZXZlcml0eSB9KSA9PiBzZXZlcml0eSA9PT0gYnRuKSxcbiAgICAgICAgKS5sZW5ndGhcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnVwZGF0ZSgpXG5cbiAgICBpZiAoc2Nyb2xsICYmIHRoaXMucmVmcy5pdGVtcykgYXdhaXQgdGhpcy5yZWZzLml0ZW1zLnNjcm9sbFRvRW5kKClcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZVRhYih0YWI6IHN0cmluZykge1xuICAgIHRoaXMuc3RhdGUuYWN0aXZlVGFiID0gdGFiXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy51cGRhdGVJdGVtcygpXG4gIH1cblxuICBwdWJsaWMgYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiKHNldmVyaXRpZXM6IFNldDxVUEkuVFNldmVyaXR5Pikge1xuICAgIGZvciAoY29uc3QgdGFiIG9mIHRoaXMudGFicy52YWx1ZXMoKSkge1xuICAgICAgaWYgKCFzZXZlcml0aWVzLmhhcyh0YWIubmFtZSkpIGNvbnRpbnVlXG4gICAgICBjb25zdCBjb3VudCA9IHRhYi5jb3VudFxuICAgICAgaWYgKGNvdW50ICYmIGNvdW50ID4gMCkge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgdGhpcy5zaG93KClcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVRhYih0YWIubmFtZSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2hvd0l0ZW0oaXRlbTogUmVzdWx0SXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICBpZiAodGhpcy5yZWZzLml0ZW1zKSB0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRBY3RpdmVUYWIoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuYWN0aXZlVGFiXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY3JlYXRlVGFiKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB7IHVyaUZpbHRlciA9IHRydWUsIGF1dG9TY3JvbGwgPSBmYWxzZSB9OiBVUEkuSVNldmVyaXR5VGFiRGVmaW5pdGlvbixcbiAgKSB7XG4gICAgaWYgKFxuICAgICAgWydlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnXS5pbmNsdWRlcyhuYW1lKSAmJlxuICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJ1xuICAgICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGlmICghQXJyYXkuZnJvbSh0aGlzLnRhYnMua2V5cygpKS5pbmNsdWRlcyhuYW1lKSkge1xuICAgICAgdGhpcy50YWJzLnNldChuYW1lLCB7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGNvdW50OiAwLFxuICAgICAgICBvbkNsaWNrOiAoKSA9PiB0aGlzLmFjdGl2YXRlVGFiKG5hbWUpLFxuICAgICAgICB1cmlGaWx0ZXIsXG4gICAgICAgIGF1dG9TY3JvbGwsXG4gICAgICB9KVxuICAgICAgaWYgKHRoaXMuc3RhdGUuYWN0aXZlVGFiKSB0aGlzLmFjdGl2YXRlVGFiKHRoaXMuc3RhdGUuYWN0aXZlVGFiKVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpOiBJU3RhdGUgJiB7IGRlc2VyaWFsaXplcjogJ2lkZS1oYXNrZWxsL091dHB1dFBhbmVsJyB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgIGRlc2VyaWFsaXplcjogJ2lkZS1oYXNrZWxsL091dHB1dFBhbmVsJyxcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lOiBzdHJpbmcsIHN0OiBVUEkuSVN0YXR1cykge1xuICAgIHRoaXMuc3RhdHVzTWFwLnNldChwbHVnaW5OYW1lLCBzdClcbiAgICB0aGlzLnByb2dyZXNzID0gQXJyYXkuZnJvbSh0aGlzLnN0YXR1c01hcC52YWx1ZXMoKSkucmVkdWNlKFxuICAgICAgKGN2LCBpKSA9PiB7XG4gICAgICAgIGlmIChpLnN0YXR1cyA9PT0gJ3Byb2dyZXNzJyAmJiBpLnByb2dyZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBjdi5wdXNoKGkucHJvZ3Jlc3MpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN2XG4gICAgICB9LFxuICAgICAgW10gYXMgbnVtYmVyW10sXG4gICAgKVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIHB1YmxpYyBzaG93TmV4dEVycm9yKCkge1xuICAgIGlmICghdGhpcy5yZXN1bHRzKSByZXR1cm5cbiAgICBjb25zdCBycyA9IEFycmF5LmZyb20odGhpcy5yZXN1bHRzLmZpbHRlcigoeyB1cmkgfSkgPT4gdXJpICE9PSB1bmRlZmluZWQpKVxuICAgIGlmIChycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHRoaXMuY3VycmVudFJlc3VsdCsrXG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA+PSBycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICB9XG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cblxuICBwdWJsaWMgc2hvd1ByZXZFcnJvcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykgcmV0dXJuXG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHsgdXJpIH0pID0+IHVyaSAhPT0gdW5kZWZpbmVkKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQtLVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPCAwKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxXG4gICAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHJpdmF0ZSBzd2l0Y2hGaWxlRmlsdGVyID0gKCkgPT4ge1xuICAgIHRoaXMuc3RhdGUuZmlsZUZpbHRlciA9ICF0aGlzLnN0YXRlLmZpbGVGaWx0ZXJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgfVxufVxuIl19