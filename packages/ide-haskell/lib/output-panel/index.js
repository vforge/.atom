"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const etch = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const status_icon_1 = require("./views/status-icon");
const utils_1 = require("../utils");
const $ = etch.dom;
class OutputPanel {
    constructor(state = { fileFilter: false, activeTab: 'error' }) {
        this.state = state;
        this.elements = new Set();
        this.disposables = new atom_1.CompositeDisposable();
        this.currentResult = 0;
        this.statusMap = new Map();
        this.progress = [];
        this.tabs = new Map();
        this.switchFileFilter = () => {
            this.state.fileFilter = !this.state.fileFilter;
            this.updateItems();
        };
        etch.initialize(this);
        for (const tab of ['error', 'warning', 'lint']) {
            this.createTab(tab, {});
        }
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.state.fileFilter)
                this.updateItems();
        }));
        setImmediate(async () => {
            await this.show();
            if (atom.config.get('ide-haskell.autoHideOutput')) {
                this.hide();
            }
        });
    }
    connectResults(results) {
        if (this.results)
            throw new Error('Results already connected!');
        this.results = results;
        const didUpdate = (severities) => {
            this.currentResult = 0;
            this.updateItems();
            if (atom.config.get('ide-haskell.autoHideOutput') && (!this.results || this.results.isEmpty(severities))) {
                this.hide();
            }
            else if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                this.activateFirstNonEmptyTab(severities);
            }
        };
        this.disposables.add(this.results.onDidUpdate(didUpdate));
        this.update();
    }
    render() {
        if (!this.results) {
            return etch.dom("ide-haskell-panel", null);
        }
        return (etch.dom("ide-haskell-panel", null,
            etch.dom("ide-haskell-panel-heading", null,
                etch.dom(status_icon_1.StatusIcon, { statusMap: this.statusMap }),
                etch.dom(output_panel_buttons_1.OutputPanelButtons, { buttons: Array.from(this.tabs.values()), activeBtn: this.state.activeTab }),
                etch.dom(output_panel_checkbox_1.OutputPanelCheckbox, { class: "ide-haskell-checkbox--uri-filter", state: this.state.fileFilter || false, onSwitched: this.switchFileFilter, enabledHint: "Show current file messages", disabledHint: "Show all project messages" }),
                Array.from(this.elements.values()),
                etch.dom(progress_bar_1.ProgressBar, { progress: this.progress })),
            etch.dom(output_panel_items_1.OutputPanelItems, { model: this.results, filter: this.itemFilter || (() => true), ref: "items" })));
    }
    async update() {
        return etch.update(this);
    }
    destroy() {
        this.hide();
    }
    async reallyDestroy() {
        await etch.destroy(this);
        this.disposables.dispose();
    }
    async toggle() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (!pane || utils_1.isDock(pane) && !pane.isVisible()) {
            return this.show();
        }
        else {
            return this.hide();
        }
    }
    async show() {
        await atom.workspace.open(this, { searchAllPanes: true, activatePane: false });
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            pane.show();
        }
    }
    hide() {
        const pane = atom.workspace.paneContainerForItem(this);
        if (pane && utils_1.isDock(pane)) {
            atom.workspace.hide(this);
        }
    }
    getTitle() {
        return 'IDE-Haskell';
    }
    getURI() {
        return `ide-haskell://output-panel/`;
    }
    getDefaultLocation() {
        return atom.config.get('ide-haskell.panelPosition');
    }
    addPanelControl(def) {
        let newElement;
        if (utils_1.isSimpleControlDef(def)) {
            const { events, classes, style, attrs } = def.opts;
            const props = {};
            if (classes) {
                props.class = classes.join(' ');
            }
            if (style) {
                props.style = style;
            }
            if (attrs) {
                props.attributes = attrs;
            }
            if (events) {
                props.on = events;
            }
            newElement = $(def.element, props);
        }
        else {
            newElement = $(def.element, def.opts);
        }
        this.elements.add(newElement);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(newElement);
            this.update();
        });
    }
    async updateItems() {
        const activeTab = this.getActiveTab();
        let currentUri;
        if (this.state.fileFilter) {
            const ed = atom.workspace.getActiveTextEditor();
            currentUri = ed && ed.getPath();
        }
        let scroll = false;
        if (activeTab) {
            const ato = this.tabs.get(activeTab);
            if (currentUri && ato && ato.uriFilter) {
                this.itemFilter = ({ uri, severity }) => (severity === activeTab) && (uri === currentUri);
            }
            else {
                this.itemFilter = ({ severity }) => severity === activeTab;
            }
            scroll = (ato && ato.autoScroll && this.refs.items && this.refs.items.atEnd()) || false;
        }
        if (this.results) {
            for (const [btn, ato] of this.tabs.entries()) {
                ato.count = Array.from(this.results.filter(({ severity }) => (severity === btn))).length;
            }
        }
        await this.update();
        if (scroll && this.refs.items)
            await this.refs.items.scrollToEnd();
    }
    activateTab(tab) {
        this.state.activeTab = tab;
        this.updateItems();
    }
    activateFirstNonEmptyTab(severities) {
        for (const i of severities) {
            const tab = this.tabs.get(i);
            if (!tab)
                continue;
            const count = tab.count;
            if (count && count > 0) {
                this.show();
                this.activateTab(i);
                break;
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items && this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.state.activeTab;
    }
    async createTab(name, { uriFilter = true, autoScroll = false }) {
        if (['error', 'warning', 'lint'].includes(name)
            && atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        if (!Array.from(this.tabs.keys()).includes(name)) {
            this.tabs.set(name, {
                name,
                count: 0,
                onClick: () => this.activateTab(name),
                uriFilter,
                autoScroll,
            });
            this.state.activeTab && this.activateTab(this.state.activeTab);
        }
        return this.update();
    }
    serialize() {
        return Object.assign({}, this.state, { deserializer: 'ide-haskell/OutputPanel' });
    }
    backendStatus(pluginName, st) {
        this.statusMap.set(pluginName, st);
        this.progress =
            Array.from(this.statusMap.values())
                .reduce((cv, i) => {
                if (i.status === 'progress' && i.progress !== undefined) {
                    cv.push(i.progress);
                }
                return cv;
            }, []);
        this.update();
    }
    showNextError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        this.currentResult++;
        if (this.currentResult >= rs.length) {
            this.currentResult = 0;
        }
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        if (!this.results)
            return;
        const rs = Array.from(this.results.filter(({ uri }) => !!uri));
        if (rs.length === 0) {
            return;
        }
        this.currentResult--;
        if (this.currentResult < 0) {
            this.currentResult = rs.length - 1;
        }
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE0QjtBQUM1QiwrQkFBc0Q7QUFDdEQsdUVBQTJFO0FBQzNFLHlFQUFtRTtBQUNuRSx1REFBa0Q7QUFDbEQsbUVBQTZEO0FBRTdELHFEQUFnRDtBQUNoRCxvQ0FBcUQ7QUFFckQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQTtBQVNsQjtJQWFFLFlBQW9CLFFBQWdCLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFO1FBQXpELFVBQUssR0FBTCxLQUFLLENBQW9EO1FBUnJFLGFBQVEsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUN0QyxnQkFBVyxHQUF3QixJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDNUQsa0JBQWEsR0FBVyxDQUFDLENBQUE7UUFDekIsY0FBUyxHQUE2QixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQy9DLGFBQVEsR0FBYSxFQUFFLENBQUE7UUFDdkIsU0FBSSxHQUEwQixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBK1F2QyxxQkFBZ0IsR0FBRyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQTtZQUU5QyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDcEIsQ0FBQyxDQUFBO1FBL1FDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFckIsR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUUvQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUN6QixDQUFDO1FBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxHQUFHLEVBQUU7WUFFakUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7Z0JBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQy9DLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDSCxZQUFZLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDdEIsTUFBTSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUE7WUFDakIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtZQUNiLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFTSxjQUFjLENBQUMsT0FBa0I7UUFDdEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQTtRQUMvRCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtRQUV0QixNQUFNLFNBQVMsR0FBRyxDQUFDLFVBQTJCLEVBQUUsRUFBRTtZQUNoRCxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsQ0FBQTtZQUV0QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDbEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1lBQ2IsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQzNDLENBQUM7UUFDSCxDQUFDLENBQUE7UUFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBRXpELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUM7SUFFTSxNQUFNO1FBQ1gsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUVsQixNQUFNLENBQUMsbUNBQW9CLENBQUE7UUFDN0IsQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUVMO1lBQ0U7Z0JBQ0UsU0FBQyx3QkFBVSxJQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxHQUFJO2dCQUN6QyxTQUFDLHlDQUFrQixJQUNqQixPQUFPLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQ3ZDLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FDL0I7Z0JBQ0YsU0FBQywyQ0FBbUIsSUFDbEIsS0FBSyxFQUFDLGtDQUFrQyxFQUN4QyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLElBQUksS0FBSyxFQUNyQyxVQUFVLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUNqQyxXQUFXLEVBQUMsNEJBQTRCLEVBQ3hDLFlBQVksRUFBQywyQkFBMkIsR0FDeEM7Z0JBQ0QsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNuQyxTQUFDLDBCQUFXLElBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEdBQUksQ0FDZDtZQUM1QixTQUFDLHFDQUFnQixJQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxFQUNuQixNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUN2QyxHQUFHLEVBQUMsT0FBTyxHQUNYLENBQ2dCLENBRXJCLENBQUE7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLE1BQU07UUFDakIsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDMUIsQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDYixDQUFDO0lBRU0sS0FBSyxDQUFDLGFBQWE7UUFDeEIsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDNUIsQ0FBQztJQUVNLEtBQUssQ0FBQyxNQUFNO1FBQ2pCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksY0FBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ3BCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUE7UUFDcEIsQ0FBQztJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSTtRQUNmLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtRQUM5RSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3RELEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxjQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1FBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRU0sSUFBSTtRQUNULE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEQsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLGNBQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUFDLENBQUM7SUFDekQsQ0FBQztJQUVNLFFBQVE7UUFDYixNQUFNLENBQUMsYUFBYSxDQUFBO0lBQ3RCLENBQUM7SUFFTSxNQUFNO1FBQ1gsTUFBTSxDQUFDLDZCQUE2QixDQUFBO0lBQ3RDLENBQUM7SUFFTSxrQkFBa0I7UUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDJCQUEyQixDQUFDLENBQUE7SUFDckQsQ0FBQztJQUVNLGVBQWUsQ0FBSSxHQUE4QjtRQUN0RCxJQUFJLFVBQXVCLENBQUE7UUFDM0IsRUFBRSxDQUFDLENBQUMsMEJBQWtCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVCLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFBO1lBQ2xELE1BQU0sS0FBSyxHQUE4QixFQUFFLENBQUE7WUFDM0MsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFBQyxDQUFDO1lBQ2hELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7WUFBQyxDQUFDO1lBQ2xDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUE7WUFBQyxDQUFDO1lBQ3ZDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUE7WUFBQyxDQUFDO1lBRWpDLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUNwQyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixVQUFVLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7UUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUU3QixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFDYixNQUFNLENBQUMsSUFBSSxpQkFBVSxDQUFDLEdBQUcsRUFBRTtZQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQTtZQUVoQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFDZixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFTSxLQUFLLENBQUMsV0FBVztRQUN0QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDckMsSUFBSSxVQUE4QixDQUFBO1FBQ2xDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUMxQixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUE7WUFDL0MsVUFBVSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDakMsQ0FBQztRQUNELElBQUksTUFBTSxHQUFZLEtBQUssQ0FBQTtRQUMzQixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2QsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDcEMsRUFBRSxDQUFDLENBQUMsVUFBVSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDdkMsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxVQUFVLENBQUMsQ0FBQTtZQUMzRixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUE7WUFDNUQsQ0FBQztZQUNELE1BQU0sR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksS0FBSyxDQUFBO1FBQ3pGLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNqQixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUM3QyxHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFFBQVEsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFBO1lBQzFGLENBQUM7UUFDSCxDQUFDO1FBRUQsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7UUFFbkIsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUNwRSxDQUFDO0lBRU0sV0FBVyxDQUFDLEdBQVc7UUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFBO1FBRTFCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUNwQixDQUFDO0lBRU0sd0JBQXdCLENBQUMsVUFBMkI7UUFDekQsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQztZQUMzQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUM1QixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztnQkFBQyxRQUFRLENBQUE7WUFDbEIsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQTtZQUN2QixFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRXZCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtnQkFDWCxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNuQixLQUFLLENBQUE7WUFDUCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFTSxRQUFRLENBQUMsSUFBZ0I7UUFDOUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ25ELENBQUM7SUFFTSxZQUFZO1FBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQTtJQUM3QixDQUFDO0lBRU0sS0FBSyxDQUFDLFNBQVMsQ0FDcEIsSUFBWSxFQUNaLEVBQUUsU0FBUyxHQUFHLElBQUksRUFBRSxVQUFVLEdBQUcsS0FBSyxFQUE4QjtRQUVwRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztlQUMxQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDekUsTUFBTSxDQUFBO1FBQ1IsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2xCLElBQUk7Z0JBQ0osS0FBSyxFQUFFLENBQUM7Z0JBQ1IsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO2dCQUNyQyxTQUFTO2dCQUNULFVBQVU7YUFDWCxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDaEUsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7SUFDdEIsQ0FBQztJQUVNLFNBQVM7UUFDZCxNQUFNLG1CQUNELElBQUksQ0FBQyxLQUFLLElBQ2IsWUFBWSxFQUFFLHlCQUF5QixJQUN4QztJQUNILENBQUM7SUFFTSxhQUFhLENBQUMsVUFBa0IsRUFBRSxFQUFlO1FBQ3RELElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNsQyxJQUFJLENBQUMsUUFBUTtZQUNYLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztpQkFDaEMsTUFBTSxDQUNQLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNSLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssVUFBVSxJQUFJLENBQUMsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztvQkFDeEQsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUE7Z0JBQ3JCLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLEVBQUUsQ0FBQTtZQUNYLENBQUMsRUFDRCxFQUFjLENBQ2YsQ0FBQTtRQUVILElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNmLENBQUM7SUFFTSxhQUFhO1FBQ2xCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUN6QixNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDOUQsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQUMsQ0FBQztRQUUvQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDcEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUUvRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRU0sYUFBYTtRQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFBQyxNQUFNLENBQUE7UUFDekIsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQzlELEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFFL0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7UUFBQyxDQUFDO1FBRWxFLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFBO0lBQ3ZDLENBQUM7Q0FPRjtBQTlSRCxrQ0E4UkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBldGNoIGZyb20gJ2V0Y2gnXG5pbXBvcnQgeyBEaXNwb3NhYmxlLCBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IElCdG5EZXNjLCBPdXRwdXRQYW5lbEJ1dHRvbnMgfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1idXR0b25zJ1xuaW1wb3J0IHsgT3V0cHV0UGFuZWxDaGVja2JveCB9IGZyb20gJy4vdmlld3Mvb3V0cHV0LXBhbmVsLWNoZWNrYm94J1xuaW1wb3J0IHsgUHJvZ3Jlc3NCYXIgfSBmcm9tICcuL3ZpZXdzL3Byb2dyZXNzLWJhcidcbmltcG9ydCB7IE91dHB1dFBhbmVsSXRlbXMgfSBmcm9tICcuL3ZpZXdzL291dHB1dC1wYW5lbC1pdGVtcydcbmltcG9ydCB7IFJlc3VsdHNEQiwgUmVzdWx0SXRlbSB9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQgeyBTdGF0dXNJY29uIH0gZnJvbSAnLi92aWV3cy9zdGF0dXMtaWNvbidcbmltcG9ydCB7IGlzRG9jaywgaXNTaW1wbGVDb250cm9sRGVmIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmNvbnN0ICQgPSBldGNoLmRvbVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIGZpbGVGaWx0ZXI6IGJvb2xlYW5cbiAgYWN0aXZlVGFiOiBzdHJpbmdcbn1cblxuZXhwb3J0IHR5cGUgVFBhbmVsUG9zaXRpb24gPSAnYm90dG9tJyB8ICdsZWZ0JyB8ICd0b3AnIHwgJ3JpZ2h0J1xuXG5leHBvcnQgY2xhc3MgT3V0cHV0UGFuZWwge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5pbml0aWFsaXplZFxuICBwcml2YXRlIHJlZnM6IHtcbiAgICBpdGVtcz86IE91dHB1dFBhbmVsSXRlbXNcbiAgfVxuICBwcml2YXRlIGVsZW1lbnRzOiBTZXQ8SlNYLkVsZW1lbnQ+ID0gbmV3IFNldCgpXG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgY3VycmVudFJlc3VsdDogbnVtYmVyID0gMFxuICBwcml2YXRlIHN0YXR1c01hcDogTWFwPHN0cmluZywgVVBJLklTdGF0dXM+ID0gbmV3IE1hcCgpXG4gIHByaXZhdGUgcHJvZ3Jlc3M6IG51bWJlcltdID0gW11cbiAgcHJpdmF0ZSB0YWJzOiBNYXA8c3RyaW5nLCBJQnRuRGVzYz4gPSBuZXcgTWFwKClcbiAgcHJpdmF0ZSBpdGVtRmlsdGVyPzogKGl0ZW06IFJlc3VsdEl0ZW0pID0+IGJvb2xlYW5cbiAgcHJpdmF0ZSByZXN1bHRzPzogUmVzdWx0c0RCXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc3RhdGU6IElTdGF0ZSA9IHsgZmlsZUZpbHRlcjogZmFsc2UsIGFjdGl2ZVRhYjogJ2Vycm9yJyB9KSB7XG4gICAgZXRjaC5pbml0aWFsaXplKHRoaXMpXG5cbiAgICBmb3IgKGNvbnN0IHRhYiBvZiBbJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCddKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIHRoaXMuY3JlYXRlVGFiKHRhYiwge30pXG4gICAgfVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSgoKSA9PiB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIGlmICh0aGlzLnN0YXRlLmZpbGVGaWx0ZXIpIHRoaXMudXBkYXRlSXRlbXMoKVxuICAgIH0pKVxuICAgIHNldEltbWVkaWF0ZShhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLnNob3coKVxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSkge1xuICAgICAgICB0aGlzLmhpZGUoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgY29ubmVjdFJlc3VsdHMocmVzdWx0czogUmVzdWx0c0RCKSB7XG4gICAgaWYgKHRoaXMucmVzdWx0cykgdGhyb3cgbmV3IEVycm9yKCdSZXN1bHRzIGFscmVhZHkgY29ubmVjdGVkIScpXG4gICAgdGhpcy5yZXN1bHRzID0gcmVzdWx0c1xuXG4gICAgY29uc3QgZGlkVXBkYXRlID0gKHNldmVyaXRpZXM6IFVQSS5UU2V2ZXJpdHlbXSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gMFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmF1dG9IaWRlT3V0cHV0JykgJiYgKCF0aGlzLnJlc3VsdHMgfHwgdGhpcy5yZXN1bHRzLmlzRW1wdHkoc2V2ZXJpdGllcykpKSB7XG4gICAgICAgIHRoaXMuaGlkZSgpXG4gICAgICB9IGVsc2UgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuc3dpdGNoVGFiT25DaGVjaycpKSB7XG4gICAgICAgIHRoaXMuYWN0aXZhdGVGaXJzdE5vbkVtcHR5VGFiKHNldmVyaXRpZXMpXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5yZXN1bHRzLm9uRGlkVXBkYXRlKGRpZFVwZGF0ZSkpXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIHJlbmRlcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcbiAgICAgIHJldHVybiA8aWRlLWhhc2tlbGwtcGFuZWwvPlxuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgLy8gdHNsaW50OmRpc2FibGU6bm8tdW5zYWZlLWFueVxuICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsPlxuICAgICAgICA8aWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZz5cbiAgICAgICAgICA8U3RhdHVzSWNvbiBzdGF0dXNNYXA9e3RoaXMuc3RhdHVzTWFwfSAvPlxuICAgICAgICAgIDxPdXRwdXRQYW5lbEJ1dHRvbnNcbiAgICAgICAgICAgIGJ1dHRvbnM9e0FycmF5LmZyb20odGhpcy50YWJzLnZhbHVlcygpKX1cbiAgICAgICAgICAgIGFjdGl2ZUJ0bj17dGhpcy5zdGF0ZS5hY3RpdmVUYWJ9XG4gICAgICAgICAgLz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxDaGVja2JveFxuICAgICAgICAgICAgY2xhc3M9XCJpZGUtaGFza2VsbC1jaGVja2JveC0tdXJpLWZpbHRlclwiXG4gICAgICAgICAgICBzdGF0ZT17dGhpcy5zdGF0ZS5maWxlRmlsdGVyIHx8IGZhbHNlfVxuICAgICAgICAgICAgb25Td2l0Y2hlZD17dGhpcy5zd2l0Y2hGaWxlRmlsdGVyfVxuICAgICAgICAgICAgZW5hYmxlZEhpbnQ9XCJTaG93IGN1cnJlbnQgZmlsZSBtZXNzYWdlc1wiXG4gICAgICAgICAgICBkaXNhYmxlZEhpbnQ9XCJTaG93IGFsbCBwcm9qZWN0IG1lc3NhZ2VzXCJcbiAgICAgICAgICAvPlxuICAgICAgICAgIHtBcnJheS5mcm9tKHRoaXMuZWxlbWVudHMudmFsdWVzKCkpfVxuICAgICAgICAgIDxQcm9ncmVzc0JhciBwcm9ncmVzcz17dGhpcy5wcm9ncmVzc30gLz5cbiAgICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICA8T3V0cHV0UGFuZWxJdGVtc1xuICAgICAgICAgIG1vZGVsPXt0aGlzLnJlc3VsdHN9XG4gICAgICAgICAgZmlsdGVyPXt0aGlzLml0ZW1GaWx0ZXIgfHwgKCgpID0+IHRydWUpfVxuICAgICAgICAgIHJlZj1cIml0ZW1zXCJcbiAgICAgICAgLz5cbiAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgICAvLyB0c2xpbnQ6ZW5hYmxlOm5vLXVuc2FmZS1hbnlcbiAgICApXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5oaWRlKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFsbHlEZXN0cm95KCkge1xuICAgIGF3YWl0IGV0Y2guZGVzdHJveSh0aGlzKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdG9nZ2xlKCkge1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9ySXRlbSh0aGlzKVxuICAgIGlmICghcGFuZSB8fCBpc0RvY2socGFuZSkgJiYgIXBhbmUuaXNWaXNpYmxlKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLnNob3coKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5oaWRlKClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2hvdygpIHtcbiAgICBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKHRoaXMsIHsgc2VhcmNoQWxsUGFuZXM6IHRydWUsIGFjdGl2YXRlUGFuZTogZmFsc2UgfSlcbiAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvckl0ZW0odGhpcylcbiAgICBpZiAocGFuZSAmJiBpc0RvY2socGFuZSkpIHsgcGFuZS5zaG93KCkgfVxuICB9XG5cbiAgcHVibGljIGhpZGUoKSB7XG4gICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JJdGVtKHRoaXMpXG4gICAgaWYgKHBhbmUgJiYgaXNEb2NrKHBhbmUpKSB7IGF0b20ud29ya3NwYWNlLmhpZGUodGhpcykgfVxuICB9XG5cbiAgcHVibGljIGdldFRpdGxlKCkge1xuICAgIHJldHVybiAnSURFLUhhc2tlbGwnXG4gIH1cblxuICBwdWJsaWMgZ2V0VVJJKCkge1xuICAgIHJldHVybiBgaWRlLWhhc2tlbGw6Ly9vdXRwdXQtcGFuZWwvYFxuICB9XG5cbiAgcHVibGljIGdldERlZmF1bHRMb2NhdGlvbigpIHtcbiAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5wYW5lbFBvc2l0aW9uJylcbiAgfVxuXG4gIHB1YmxpYyBhZGRQYW5lbENvbnRyb2w8VD4oZGVmOiBVUEkuVENvbnRyb2xEZWZpbml0aW9uPFQ+KSB7XG4gICAgbGV0IG5ld0VsZW1lbnQ6IEpTWC5FbGVtZW50XG4gICAgaWYgKGlzU2ltcGxlQ29udHJvbERlZihkZWYpKSB7XG4gICAgICBjb25zdCB7IGV2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzIH0gPSBkZWYub3B0c1xuICAgICAgY29uc3QgcHJvcHM6IHsgW2tleTogc3RyaW5nXTogT2JqZWN0IH0gPSB7fVxuICAgICAgaWYgKGNsYXNzZXMpIHsgcHJvcHMuY2xhc3MgPSBjbGFzc2VzLmpvaW4oJyAnKSB9XG4gICAgICBpZiAoc3R5bGUpIHsgcHJvcHMuc3R5bGUgPSBzdHlsZSB9XG4gICAgICBpZiAoYXR0cnMpIHsgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzIH1cbiAgICAgIGlmIChldmVudHMpIHsgcHJvcHMub24gPSBldmVudHMgfVxuXG4gICAgICBuZXdFbGVtZW50ID0gJChkZWYuZWxlbWVudCwgcHJvcHMpXG4gICAgfSBlbHNlIHtcbiAgICAgIG5ld0VsZW1lbnQgPSAkKGRlZi5lbGVtZW50LCBkZWYub3B0cylcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50cy5hZGQobmV3RWxlbWVudClcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKG5ld0VsZW1lbnQpXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIHRoaXMudXBkYXRlKClcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHVwZGF0ZUl0ZW1zKCkge1xuICAgIGNvbnN0IGFjdGl2ZVRhYiA9IHRoaXMuZ2V0QWN0aXZlVGFiKClcbiAgICBsZXQgY3VycmVudFVyaTogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgaWYgKHRoaXMuc3RhdGUuZmlsZUZpbHRlcikge1xuICAgICAgY29uc3QgZWQgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICAgIGN1cnJlbnRVcmkgPSBlZCAmJiBlZC5nZXRQYXRoKClcbiAgICB9XG4gICAgbGV0IHNjcm9sbDogYm9vbGVhbiA9IGZhbHNlXG4gICAgaWYgKGFjdGl2ZVRhYikge1xuICAgICAgY29uc3QgYXRvID0gdGhpcy50YWJzLmdldChhY3RpdmVUYWIpXG4gICAgICBpZiAoY3VycmVudFVyaSAmJiBhdG8gJiYgYXRvLnVyaUZpbHRlcikge1xuICAgICAgICB0aGlzLml0ZW1GaWx0ZXIgPSAoeyB1cmksIHNldmVyaXR5IH0pID0+IChzZXZlcml0eSA9PT0gYWN0aXZlVGFiKSAmJiAodXJpID09PSBjdXJyZW50VXJpKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5pdGVtRmlsdGVyID0gKHsgc2V2ZXJpdHkgfSkgPT4gc2V2ZXJpdHkgPT09IGFjdGl2ZVRhYlxuICAgICAgfVxuICAgICAgc2Nyb2xsID0gKGF0byAmJiBhdG8uYXV0b1Njcm9sbCAmJiB0aGlzLnJlZnMuaXRlbXMgJiYgdGhpcy5yZWZzLml0ZW1zLmF0RW5kKCkpIHx8IGZhbHNlXG4gICAgfVxuXG4gICAgaWYgKHRoaXMucmVzdWx0cykge1xuICAgICAgZm9yIChjb25zdCBbYnRuLCBhdG9dIG9mIHRoaXMudGFicy5lbnRyaWVzKCkpIHtcbiAgICAgICAgYXRvLmNvdW50ID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7IHNldmVyaXR5IH0pID0+IChzZXZlcml0eSA9PT0gYnRuKSkpLmxlbmd0aFxuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMudXBkYXRlKClcblxuICAgIGlmIChzY3JvbGwgJiYgdGhpcy5yZWZzLml0ZW1zKSBhd2FpdCB0aGlzLnJlZnMuaXRlbXMuc2Nyb2xsVG9FbmQoKVxuICB9XG5cbiAgcHVibGljIGFjdGl2YXRlVGFiKHRhYjogc3RyaW5nKSB7XG4gICAgdGhpcy5zdGF0ZS5hY3RpdmVUYWIgPSB0YWJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgfVxuXG4gIHB1YmxpYyBhY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIoc2V2ZXJpdGllczogVVBJLlRTZXZlcml0eVtdKSB7XG4gICAgZm9yIChjb25zdCBpIG9mIHNldmVyaXRpZXMpIHtcbiAgICAgIGNvbnN0IHRhYiA9IHRoaXMudGFicy5nZXQoaSlcbiAgICAgIGlmICghdGFiKSBjb250aW51ZVxuICAgICAgY29uc3QgY291bnQgPSB0YWIuY291bnRcbiAgICAgIGlmIChjb3VudCAmJiBjb3VudCA+IDApIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgIHRoaXMuc2hvdygpXG4gICAgICAgIHRoaXMuYWN0aXZhdGVUYWIoaSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2hvd0l0ZW0oaXRlbTogUmVzdWx0SXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICB0aGlzLnJlZnMuaXRlbXMgJiYgdGhpcy5yZWZzLml0ZW1zLnNob3dJdGVtKGl0ZW0pXG4gIH1cblxuICBwdWJsaWMgZ2V0QWN0aXZlVGFiKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLmFjdGl2ZVRhYlxuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZVRhYihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgeyB1cmlGaWx0ZXIgPSB0cnVlLCBhdXRvU2Nyb2xsID0gZmFsc2UgfTogVVBJLklTZXZlcml0eVRhYkRlZmluaXRpb24sXG4gICkge1xuICAgIGlmIChbJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCddLmluY2x1ZGVzKG5hbWUpXG4gICAgICAmJiBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2J1aWx0aW4nKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgaWYgKCFBcnJheS5mcm9tKHRoaXMudGFicy5rZXlzKCkpLmluY2x1ZGVzKG5hbWUpKSB7XG4gICAgICB0aGlzLnRhYnMuc2V0KG5hbWUsIHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgY291bnQ6IDAsXG4gICAgICAgIG9uQ2xpY2s6ICgpID0+IHRoaXMuYWN0aXZhdGVUYWIobmFtZSksXG4gICAgICAgIHVyaUZpbHRlcixcbiAgICAgICAgYXV0b1Njcm9sbCxcbiAgICAgIH0pXG4gICAgICB0aGlzLnN0YXRlLmFjdGl2ZVRhYiAmJiB0aGlzLmFjdGl2YXRlVGFiKHRoaXMuc3RhdGUuYWN0aXZlVGFiKVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy51cGRhdGUoKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpOiBJU3RhdGUgJiB7ZGVzZXJpYWxpemVyOiAnaWRlLWhhc2tlbGwvT3V0cHV0UGFuZWwnfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICBkZXNlcmlhbGl6ZXI6ICdpZGUtaGFza2VsbC9PdXRwdXRQYW5lbCcsXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGJhY2tlbmRTdGF0dXMocGx1Z2luTmFtZTogc3RyaW5nLCBzdDogVVBJLklTdGF0dXMpIHtcbiAgICB0aGlzLnN0YXR1c01hcC5zZXQocGx1Z2luTmFtZSwgc3QpXG4gICAgdGhpcy5wcm9ncmVzcyA9XG4gICAgICBBcnJheS5mcm9tKHRoaXMuc3RhdHVzTWFwLnZhbHVlcygpKVxuICAgICAgICAucmVkdWNlKFxuICAgICAgICAoY3YsIGkpID0+IHtcbiAgICAgICAgICBpZiAoaS5zdGF0dXMgPT09ICdwcm9ncmVzcycgJiYgaS5wcm9ncmVzcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjdi5wdXNoKGkucHJvZ3Jlc3MpXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBjdlxuICAgICAgICB9LFxuICAgICAgICBbXSBhcyBudW1iZXJbXSxcbiAgICAgIClcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICB0aGlzLnVwZGF0ZSgpXG4gIH1cblxuICBwdWJsaWMgc2hvd05leHRFcnJvcigpIHtcbiAgICBpZiAoIXRoaXMucmVzdWx0cykgcmV0dXJuXG4gICAgY29uc3QgcnMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy5maWx0ZXIoKHsgdXJpIH0pID0+ICEhdXJpKSlcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSB7IHJldHVybiB9XG5cbiAgICB0aGlzLmN1cnJlbnRSZXN1bHQrK1xuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPj0gcnMubGVuZ3RoKSB7IHRoaXMuY3VycmVudFJlc3VsdCA9IDAgfVxuXG4gICAgdGhpcy5zaG93SXRlbShyc1t0aGlzLmN1cnJlbnRSZXN1bHRdKVxuICB9XG5cbiAgcHVibGljIHNob3dQcmV2RXJyb3IoKSB7XG4gICAgaWYgKCF0aGlzLnJlc3VsdHMpIHJldHVyblxuICAgIGNvbnN0IHJzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMuZmlsdGVyKCh7IHVyaSB9KSA9PiAhIXVyaSkpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gfVxuXG4gICAgdGhpcy5jdXJyZW50UmVzdWx0LS1cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0IDwgMCkgeyB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxIH1cblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxuXG4gIHByaXZhdGUgc3dpdGNoRmlsZUZpbHRlciA9ICgpID0+IHtcbiAgICB0aGlzLnN0YXRlLmZpbGVGaWx0ZXIgPSAhdGhpcy5zdGF0ZS5maWxlRmlsdGVyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgdGhpcy51cGRhdGVJdGVtcygpXG4gIH1cbn1cbiJdfQ==