"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const tooltip_manager_1 = require("./tooltip-manager");
class EditorControl {
    constructor(editor, pluginManager) {
        this.editor = editor;
        this.trackMouseBufferPosition = (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (!bufferPt) {
                return;
            }
            if (this.lastMouseBufferPt && this.lastMouseBufferPt.isEqual(bufferPt)) {
                return;
            }
            this.lastMouseBufferPt = bufferPt;
            if (this.exprTypeTimeout !== undefined) {
                clearTimeout(this.exprTypeTimeout);
            }
            this.exprTypeTimeout = window.setTimeout(() => {
                this.shouldShowTooltip(bufferPt, "mouse");
            }, atom.config.get('ide-haskell.expressionTypeInterval', {
                scope: this.editor.getRootScopeDescriptor(),
            }));
        };
        this.stopTrackingMouseBufferPosition = () => {
            if (this.exprTypeTimeout !== undefined) {
                return clearTimeout(this.exprTypeTimeout);
            }
        };
        this.trackSelection = ({ newBufferRange }) => {
            this.handleCursorUnderTooltip(newBufferRange);
            if (this.selTimeout !== undefined) {
                clearTimeout(this.selTimeout);
            }
            if (newBufferRange.isEmpty()) {
                this.tooltips.hide("selection");
                if (this.exprTypeTimeout !== undefined) {
                    clearTimeout(this.exprTypeTimeout);
                }
                this.tooltipRegistry.showTooltip(this.editor, "keyboard");
                if (atom.config.get('ide-haskell.onCursorMove', {
                    scope: this.editor.getRootScopeDescriptor(),
                }) === 'Hide Tooltip') {
                    this.tooltips.hide("mouse", undefined, {
                        persistent: false,
                    });
                    this.tooltips.hide("context", undefined, {
                        persistent: false,
                    });
                }
            }
            else {
                this.selTimeout = window.setTimeout(() => this.shouldShowTooltip(newBufferRange.start, "selection"), atom.config.get('ide-haskell.expressionTypeInterval', {
                    scope: this.editor.getRootScopeDescriptor(),
                }));
            }
        };
        this.disposables = new atom_1.CompositeDisposable();
        this.tooltips = new tooltip_manager_1.TooltipManager(this.editor);
        this.disposables.add(this.tooltips);
        this.tooltipRegistry = pluginManager.tooltipRegistry;
        this.editorElement = atom.views.getView(this.editor);
        const buffer = this.editor.getBuffer();
        this.disposables.add(buffer.onWillSave(() => pluginManager.willSaveBuffer(buffer)), buffer.onDidSave(() => pluginManager.didSaveBuffer(buffer)), this.editor.onDidStopChanging(() => pluginManager.didStopChanging(buffer)), this.editorElement.onDidChangeScrollLeft(() => this.tooltips.hide("mouse")), this.editorElement.onDidChangeScrollTop(() => this.tooltips.hide("mouse")), utils_1.listen(this.editorElement, 'mousemove', '.scroll-view', this.trackMouseBufferPosition), utils_1.listen(this.editorElement, 'mouseout', '.scroll-view', this.stopTrackingMouseBufferPosition), this.editor.onDidChangeSelectionRange(this.trackSelection));
    }
    static supportsGrammar(grammar) {
        return [
            'source.haskell',
            'text.tex.latex.haskell',
        ].includes(grammar);
    }
    destroy() {
        if (this.exprTypeTimeout !== undefined) {
            clearTimeout(this.exprTypeTimeout);
        }
        if (this.selTimeout !== undefined) {
            clearTimeout(this.selTimeout);
        }
        this.disposables.dispose();
        this.lastMouseBufferPt = undefined;
    }
    getEventRange(eventType) {
        let crange;
        let pos;
        switch (eventType) {
            case 'mouse':
            case 'context':
                if (!this.lastMouseBufferPt)
                    return undefined;
                pos = this.lastMouseBufferPt;
                const selRanges = this.editor
                    .getSelections()
                    .map((sel) => sel.getBufferRange())
                    .filter((sel) => sel.containsPoint(pos));
                crange = selRanges.length > 0 ? selRanges[0] : new atom_1.Range(pos, pos);
                break;
            case 'keyboard':
            case 'selection':
                crange = this.editor.getLastSelection().getBufferRange();
                pos = crange.start;
                break;
            default:
                throw new TypeError('Switch assertion failed');
        }
        return { crange, pos, eventType };
    }
    shouldShowTooltip(pos, type) {
        if (pos.row < 0 ||
            pos.row >= this.editor.getLineCount() ||
            pos.isEqual(this.editor.getBuffer().rangeForRow(pos.row, false).end)) {
            this.tooltips.hide(type);
        }
        else {
            this.tooltipRegistry.showTooltip(this.editor, type);
        }
    }
    handleCursorUnderTooltip(currentRange) {
        const tooltipElement = document.querySelector('ide-haskell-tooltip');
        if (!tooltipElement) {
            return;
        }
        const slcl = this.editorElement.pixelRectForScreenRange(this.editor.screenRangeForBufferRange(currentRange));
        const sv = this.editorElement.querySelector('.scroll-view');
        if (!sv) {
            return;
        }
        const eecl = sv.getBoundingClientRect();
        const ttcl = tooltipElement.getBoundingClientRect();
        const div = tooltipElement.querySelector('div');
        if (!div) {
            return;
        }
        const ttcld = div.getBoundingClientRect();
        const ttbox = {
            left: ttcl.left - eecl.left,
            top: ttcld.top - eecl.top,
            width: ttcl.width,
            height: ttcld.height,
        };
        const xmax = Math.round(Math.max(ttbox.left, slcl.left));
        const xmin = Math.round(Math.min(ttbox.left + ttbox.width, slcl.left + slcl.width));
        const ymax = Math.round(Math.max(ttbox.top, slcl.top));
        const ymin = Math.round(Math.min(ttbox.top + ttbox.height, slcl.top + slcl.height));
        const tt = document.querySelector('ide-haskell-tooltip');
        if (tt) {
            if (ymax <= ymin && xmax <= xmin) {
                tt.classList.add('ide-haskell-tooltip-subdued');
            }
            else {
                tt.classList.remove('ide-haskell-tooltip-subdued');
            }
        }
    }
}
exports.EditorControl = EditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLWNvbnRyb2wvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBZ0Y7QUFDaEYsb0NBQStEO0FBQy9ELHVEQUFrRDtBQVVsRDtJQW1CRSxZQUFvQixNQUFrQixFQUFFLGFBQTRCO1FBQWhELFdBQU0sR0FBTixNQUFNLENBQVk7UUFxRzlCLDZCQUF3QixHQUFHLENBQUMsQ0FBYSxFQUFFLEVBQUU7WUFDbkQsTUFBTSxRQUFRLEdBQUcsb0NBQTRCLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUM3RCxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ2QsTUFBTSxDQUFBO1lBQ1IsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkUsTUFBTSxDQUFBO1lBQ1IsQ0FBQztZQUNELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxRQUFRLENBQUE7WUFFakMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN2QyxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO1lBQ3BDLENBQUM7WUFDRCxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQ3RDLEdBQUcsRUFBRTtnQkFDSCxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxVQUF3QixDQUFBO1lBQ3pELENBQUMsRUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsRUFBRTtnQkFDcEQsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLEVBQUU7YUFDNUMsQ0FBQyxDQUNILENB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QUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQzNELENBQUE7UUFDRCxNQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUMvQixxQkFBcUIsQ0FDQSxDQUFBO1FBQ3ZCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDUCxFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNqQyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFBO1lBQ2pELENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFBO1lBQ3BELENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBek9ELHNDQXlPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJhbmdlLCBUZXh0RWRpdG9yLCBQb2ludCwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50LCBsaXN0ZW4gfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7IFRvb2x0aXBNYW5hZ2VyIH0gZnJvbSAnLi90b29sdGlwLW1hbmFnZXInXG5pbXBvcnQgeyBUb29sdGlwUmVnaXN0cnkgfSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHsgUGx1Z2luTWFuYWdlciwgSUVkaXRvckNvbnRyb2xsZXIgfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcbmltcG9ydCAqIGFzIFVQSSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IFRFdmVudFJhbmdlVHlwZSA9IFVQSS5URXZlbnRSYW5nZVR5cGVcblxuZXhwb3J0IHR5cGUgVEV2ZW50UmFuZ2VSZXN1bHQgPVxuICB8IHsgY3JhbmdlOiBSYW5nZTsgcG9zOiBQb2ludDsgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGUgfVxuICB8IHVuZGVmaW5lZFxuXG5leHBvcnQgY2xhc3MgRWRpdG9yQ29udHJvbCBpbXBsZW1lbnRzIElFZGl0b3JDb250cm9sbGVyIHtcbiAgcHVibGljIHRvb2x0aXBzOiBUb29sdGlwTWFuYWdlclxuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgbGFzdE1vdXNlQnVmZmVyUHQ/OiBQb2ludFxuICBwcml2YXRlIGV4cHJUeXBlVGltZW91dD86IG51bWJlclxuICBwcml2YXRlIHNlbFRpbWVvdXQ/OiBudW1iZXJcbiAgcHJpdmF0ZSBlZGl0b3JFbGVtZW50OiBIVE1MRWxlbWVudCAmIHtcbiAgICBvbkRpZENoYW5nZVNjcm9sbFRvcChhOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZVxuICAgIG9uRGlkQ2hhbmdlU2Nyb2xsTGVmdChhOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZVxuICAgIHBpeGVsUmVjdEZvclNjcmVlblJhbmdlKFxuICAgICAgcjogUmFuZ2UsXG4gICAgKToge1xuICAgICAgbGVmdDogbnVtYmVyXG4gICAgICB0b3A6IG51bWJlclxuICAgICAgd2lkdGg6IG51bWJlclxuICAgICAgaGVpZ2h0OiBudW1iZXJcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSB0b29sdGlwUmVnaXN0cnk6IFRvb2x0aXBSZWdpc3RyeVxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy50b29sdGlwcyA9IG5ldyBUb29sdGlwTWFuYWdlcih0aGlzLmVkaXRvcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnRvb2x0aXBzKVxuICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5ID0gcGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnlcblxuICAgIHRoaXMuZWRpdG9yRWxlbWVudCA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvcikgYXMgYW55XG5cbiAgICBjb25zdCBidWZmZXIgPSB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAvLyBidWZmZXIgZXZlbnRzIGZvciBhdXRvbWF0aWMgY2hlY2tcbiAgICAgIGJ1ZmZlci5vbldpbGxTYXZlKCgpID0+IHBsdWdpbk1hbmFnZXIud2lsbFNhdmVCdWZmZXIoYnVmZmVyKSksXG4gICAgICBidWZmZXIub25EaWRTYXZlKCgpID0+IHBsdWdpbk1hbmFnZXIuZGlkU2F2ZUJ1ZmZlcihidWZmZXIpKSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkU3RvcENoYW5naW5nKCgpID0+XG4gICAgICAgIHBsdWdpbk1hbmFnZXIuZGlkU3RvcENoYW5naW5nKGJ1ZmZlciksXG4gICAgICApLFxuICAgICAgLy8gdG9vbHRpcCB0cmFja2luZyAobW91c2UgYW5kIHNlbGVjdGlvbilcbiAgICAgIHRoaXMuZWRpdG9yRWxlbWVudC5vbkRpZENoYW5nZVNjcm9sbExlZnQoKCkgPT5cbiAgICAgICAgdGhpcy50b29sdGlwcy5oaWRlKFRFdmVudFJhbmdlVHlwZS5tb3VzZSksXG4gICAgICApLFxuICAgICAgdGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsVG9wKCgpID0+XG4gICAgICAgIHRoaXMudG9vbHRpcHMuaGlkZShURXZlbnRSYW5nZVR5cGUubW91c2UpLFxuICAgICAgKSxcbiAgICAgIGxpc3RlbihcbiAgICAgICAgdGhpcy5lZGl0b3JFbGVtZW50LFxuICAgICAgICAnbW91c2Vtb3ZlJyxcbiAgICAgICAgJy5zY3JvbGwtdmlldycsXG4gICAgICAgIHRoaXMudHJhY2tNb3VzZUJ1ZmZlclBvc2l0aW9uLFxuICAgICAgKSxcbiAgICAgIGxpc3RlbihcbiAgICAgICAgdGhpcy5lZGl0b3JFbGVtZW50LFxuICAgICAgICAnbW91c2VvdXQnLFxuICAgICAgICAnLnNjcm9sbC12aWV3JyxcbiAgICAgICAgdGhpcy5zdG9wVHJhY2tpbmdNb3VzZUJ1ZmZlclBvc2l0aW9uLFxuICAgICAgKSxcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkQ2hhbmdlU2VsZWN0aW9uUmFuZ2UodGhpcy50cmFja1NlbGVjdGlvbiksXG4gICAgKVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBzdXBwb3J0c0dyYW1tYXIoZ3JhbW1hcjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIC8vICdzb3VyY2UuYzJocycsXG4gICAgICAvLyAnc291cmNlLmNhYmFsJyxcbiAgICAgIC8vICdzb3VyY2UuaHNjMmhzJyxcbiAgICAgICdzb3VyY2UuaGFza2VsbCcsXG4gICAgICAndGV4dC50ZXgubGF0ZXguaGFza2VsbCcsXG4gICAgICAvLyAnc291cmNlLmhzaWcnLFxuICAgIF0uaW5jbHVkZXMoZ3JhbW1hcilcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICAgIGlmICh0aGlzLnNlbFRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc2VsVGltZW91dClcbiAgICB9XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0ID0gdW5kZWZpbmVkXG4gIH1cblxuICBwdWJsaWMgZ2V0RXZlbnRSYW5nZShldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZSk6IFRFdmVudFJhbmdlUmVzdWx0IHtcbiAgICBsZXQgY3JhbmdlOiBSYW5nZVxuICAgIGxldCBwb3M6IFBvaW50XG4gICAgc3dpdGNoIChldmVudFR5cGUpIHtcbiAgICAgIGNhc2UgJ21vdXNlJzpcbiAgICAgIGNhc2UgJ2NvbnRleHQnOlxuICAgICAgICBpZiAoIXRoaXMubGFzdE1vdXNlQnVmZmVyUHQpIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgcG9zID0gdGhpcy5sYXN0TW91c2VCdWZmZXJQdFxuICAgICAgICBjb25zdCBzZWxSYW5nZXMgPSB0aGlzLmVkaXRvclxuICAgICAgICAgIC5nZXRTZWxlY3Rpb25zKClcbiAgICAgICAgICAubWFwKChzZWwpID0+IHNlbC5nZXRCdWZmZXJSYW5nZSgpKVxuICAgICAgICAgIC5maWx0ZXIoKHNlbCkgPT4gc2VsLmNvbnRhaW5zUG9pbnQocG9zKSlcbiAgICAgICAgY3JhbmdlID0gc2VsUmFuZ2VzLmxlbmd0aCA+IDAgPyBzZWxSYW5nZXNbMF0gOiBuZXcgUmFuZ2UocG9zLCBwb3MpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdrZXlib2FyZCc6XG4gICAgICBjYXNlICdzZWxlY3Rpb24nOlxuICAgICAgICBjcmFuZ2UgPSB0aGlzLmVkaXRvci5nZXRMYXN0U2VsZWN0aW9uKCkuZ2V0QnVmZmVyUmFuZ2UoKVxuICAgICAgICBwb3MgPSBjcmFuZ2Uuc3RhcnRcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1N3aXRjaCBhc3NlcnRpb24gZmFpbGVkJylcbiAgICB9XG5cbiAgICByZXR1cm4geyBjcmFuZ2UsIHBvcywgZXZlbnRUeXBlIH1cbiAgfVxuXG4gIHByaXZhdGUgc2hvdWxkU2hvd1Rvb2x0aXAocG9zOiBQb2ludCwgdHlwZTogVEV2ZW50UmFuZ2VUeXBlKSB7XG4gICAgaWYgKFxuICAgICAgcG9zLnJvdyA8IDAgfHxcbiAgICAgIHBvcy5yb3cgPj0gdGhpcy5lZGl0b3IuZ2V0TGluZUNvdW50KCkgfHxcbiAgICAgIHBvcy5pc0VxdWFsKHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLnJhbmdlRm9yUm93KHBvcy5yb3csIGZhbHNlKS5lbmQpXG4gICAgKSB7XG4gICAgICB0aGlzLnRvb2x0aXBzLmhpZGUodHlwZSlcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICB0aGlzLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcCh0aGlzLmVkaXRvciwgdHlwZSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyYWNrTW91c2VCdWZmZXJQb3NpdGlvbiA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgY29uc3QgYnVmZmVyUHQgPSBidWZmZXJQb3NpdGlvbkZyb21Nb3VzZUV2ZW50KHRoaXMuZWRpdG9yLCBlKVxuICAgIGlmICghYnVmZmVyUHQpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmICh0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0ICYmIHRoaXMubGFzdE1vdXNlQnVmZmVyUHQuaXNFcXVhbChidWZmZXJQdCkpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICB0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0ID0gYnVmZmVyUHRcblxuICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICAgIHRoaXMuZXhwclR5cGVUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAoYnVmZmVyUHQsIFRFdmVudFJhbmdlVHlwZS5tb3VzZSlcbiAgICAgIH0sXG4gICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmV4cHJlc3Npb25UeXBlSW50ZXJ2YWwnLCB7XG4gICAgICAgIHNjb3BlOiB0aGlzLmVkaXRvci5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCksXG4gICAgICB9KSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHN0b3BUcmFja2luZ01vdXNlQnVmZmVyUG9zaXRpb24gPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmFja1NlbGVjdGlvbiA9ICh7IG5ld0J1ZmZlclJhbmdlIH06IHsgbmV3QnVmZmVyUmFuZ2U6IFJhbmdlIH0pID0+IHtcbiAgICB0aGlzLmhhbmRsZUN1cnNvclVuZGVyVG9vbHRpcChuZXdCdWZmZXJSYW5nZSlcblxuICAgIGlmICh0aGlzLnNlbFRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc2VsVGltZW91dClcbiAgICB9XG4gICAgaWYgKG5ld0J1ZmZlclJhbmdlLmlzRW1wdHkoKSkge1xuICAgICAgdGhpcy50b29sdGlwcy5oaWRlKFRFdmVudFJhbmdlVHlwZS5zZWxlY3Rpb24pXG4gICAgICBpZiAodGhpcy5leHByVHlwZVRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgICB9XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIHRoaXMudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKHRoaXMuZWRpdG9yLCBURXZlbnRSYW5nZVR5cGUua2V5Ym9hcmQpXG4gICAgICBpZiAoXG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwub25DdXJzb3JNb3ZlJywge1xuICAgICAgICAgIHNjb3BlOiB0aGlzLmVkaXRvci5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCksXG4gICAgICAgIH0pID09PSAnSGlkZSBUb29sdGlwJ1xuICAgICAgKSB7XG4gICAgICAgIHRoaXMudG9vbHRpcHMuaGlkZShURXZlbnRSYW5nZVR5cGUubW91c2UsIHVuZGVmaW5lZCwge1xuICAgICAgICAgIHBlcnNpc3RlbnQ6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICB0aGlzLnRvb2x0aXBzLmhpZGUoVEV2ZW50UmFuZ2VUeXBlLmNvbnRleHQsIHVuZGVmaW5lZCwge1xuICAgICAgICAgIHBlcnNpc3RlbnQ6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNlbFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgKCkgPT5cbiAgICAgICAgICB0aGlzLnNob3VsZFNob3dUb29sdGlwKFxuICAgICAgICAgICAgbmV3QnVmZmVyUmFuZ2Uuc3RhcnQsXG4gICAgICAgICAgICBURXZlbnRSYW5nZVR5cGUuc2VsZWN0aW9uLFxuICAgICAgICAgICksXG4gICAgICAgIGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuZXhwcmVzc2lvblR5cGVJbnRlcnZhbCcsIHtcbiAgICAgICAgICBzY29wZTogdGhpcy5lZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpLFxuICAgICAgICB9KSxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUN1cnNvclVuZGVyVG9vbHRpcChjdXJyZW50UmFuZ2U6IFJhbmdlKSB7XG4gICAgY29uc3QgdG9vbHRpcEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpZGUtaGFza2VsbC10b29sdGlwJylcbiAgICBpZiAoIXRvb2x0aXBFbGVtZW50KSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3Qgc2xjbCA9IHRoaXMuZWRpdG9yRWxlbWVudC5waXhlbFJlY3RGb3JTY3JlZW5SYW5nZShcbiAgICAgIHRoaXMuZWRpdG9yLnNjcmVlblJhbmdlRm9yQnVmZmVyUmFuZ2UoY3VycmVudFJhbmdlKSxcbiAgICApXG4gICAgY29uc3Qgc3YgPSB0aGlzLmVkaXRvckVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNjcm9sbC12aWV3JylcbiAgICBpZiAoIXN2KSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgZWVjbCA9IHN2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgdHRjbCA9IHRvb2x0aXBFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgZGl2ID0gdG9vbHRpcEVsZW1lbnQucXVlcnlTZWxlY3RvcignZGl2JylcbiAgICBpZiAoIWRpdikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IHR0Y2xkID0gZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgdHRib3ggPSB7XG4gICAgICBsZWZ0OiB0dGNsLmxlZnQgLSBlZWNsLmxlZnQsXG4gICAgICB0b3A6IHR0Y2xkLnRvcCAtIGVlY2wudG9wLFxuICAgICAgd2lkdGg6IHR0Y2wud2lkdGgsXG4gICAgICBoZWlnaHQ6IHR0Y2xkLmhlaWdodCxcbiAgICB9XG4gICAgY29uc3QgeG1heCA9IE1hdGgucm91bmQoTWF0aC5tYXgodHRib3gubGVmdCwgc2xjbC5sZWZ0KSlcbiAgICBjb25zdCB4bWluID0gTWF0aC5yb3VuZChcbiAgICAgIE1hdGgubWluKHR0Ym94LmxlZnQgKyB0dGJveC53aWR0aCwgc2xjbC5sZWZ0ICsgc2xjbC53aWR0aCksXG4gICAgKVxuICAgIGNvbnN0IHltYXggPSBNYXRoLnJvdW5kKE1hdGgubWF4KHR0Ym94LnRvcCwgc2xjbC50b3ApKVxuICAgIGNvbnN0IHltaW4gPSBNYXRoLnJvdW5kKFxuICAgICAgTWF0aC5taW4odHRib3gudG9wICsgdHRib3guaGVpZ2h0LCBzbGNsLnRvcCArIHNsY2wuaGVpZ2h0KSxcbiAgICApXG4gICAgY29uc3QgdHQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgJ2lkZS1oYXNrZWxsLXRvb2x0aXAnLFxuICAgICkgYXMgSFRNTEVsZW1lbnQgfCBudWxsXG4gICAgaWYgKHR0KSB7XG4gICAgICBpZiAoeW1heCA8PSB5bWluICYmIHhtYXggPD0geG1pbikge1xuICAgICAgICB0dC5jbGFzc0xpc3QuYWRkKCdpZGUtaGFza2VsbC10b29sdGlwLXN1YmR1ZWQnKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHQuY2xhc3NMaXN0LnJlbW92ZSgnaWRlLWhhc2tlbGwtdG9vbHRpcC1zdWJkdWVkJylcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==