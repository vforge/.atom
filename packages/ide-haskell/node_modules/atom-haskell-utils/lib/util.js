"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const fs = require("fs");
const path = require("path");
function hasGetPath(dir) {
    return dir && dir.getPath && typeof dir.getPath === 'function';
}
function isTextBuffer(x) {
    return x && x.file;
}
function isDirectory(dir) {
    if (dir === null) {
        return false;
    }
    if (hasGetPath(dir)) {
        return isDirectory(dir.getPath());
    }
    else if (typeof dir === 'string') {
        try {
            return fs.statSync(dir).isDirectory();
        }
        catch (e) {
            return false;
        }
    }
    else {
        return false;
    }
}
exports.isDirectory = isDirectory;
function getRootDirFallback(file) {
    let dir = null;
    if (file) {
        [dir] = atom.project.getDirectories().filter((d) => d.contains(file.getPath()));
    }
    if (!dir) {
        dir = atom.project.getDirectories()[0];
    }
    if (dir && dir.getPath() === 'atom://config') {
        dir = null;
    }
    if (!(dir && isDirectory(dir))) {
        if (file) {
            dir = file.getParent();
        }
        else {
            dir = new atom_1.Directory('.');
        }
    }
    return dir;
}
exports.getRootDirFallback = getRootDirFallback;
function getDirEntries(dir) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => dir.getEntries((error, contents) => {
            if (error) {
                reject(error);
            }
            else {
                resolve(contents);
            }
        }));
    });
}
exports.getDirEntries = getDirEntries;
function getRootDir(input) {
    return __awaiter(this, void 0, void 0, function* () {
        function dirHasCabalFile(d) {
            return __awaiter(this, void 0, void 0, function* () {
                if (!d) {
                    return false;
                }
                return (yield getDirEntries(d)).some((file) => file.isFile() && file.getBaseName().endsWith('.cabal'));
            });
        }
        function dirHasSandboxFile(d) {
            return __awaiter(this, void 0, void 0, function* () {
                if (!d) {
                    return false;
                }
                return (yield getDirEntries(d)).some((file) => file.isFile() && file.getBaseName() === 'cabal.sandbox.config');
            });
        }
        function findProjectRoot(d, check) {
            return __awaiter(this, void 0, void 0, function* () {
                while (!(d && d.isRoot && d.isRoot() || !d || (yield check(d)))) {
                    d = d && d.getParent();
                }
                if (yield check(d)) {
                    return d;
                }
                else {
                    return null;
                }
            });
        }
        let file;
        if (isTextBuffer(input)) {
            file = new atom_1.File(input.getPath());
        }
        else if (hasGetPath(input)) {
            file = input;
        }
        else if (typeof input === 'string') {
            file = new atom_1.File(input);
        }
        else {
            file = null;
        }
        let dir;
        if (file && isDirectory(file)) {
            dir = new atom_1.Directory(file.getPath());
        }
        else {
            dir = file && file.getParent() || getRootDirFallback(file);
        }
        const cabalRoot = yield findProjectRoot(dir, dirHasCabalFile);
        const sandboxRoot = yield findProjectRoot(dir, dirHasSandboxFile);
        dir = cabalRoot || sandboxRoot;
        if (!(dir && isDirectory(dir))) {
            dir = getRootDirFallback(file);
        }
        return dir;
    });
}
exports.getRootDir = getRootDir;
const HS = require('../hs/hs.min.js');
function parseDotCabal(cabalSource) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve) => {
            HS.parseDotCabal(cabalSource, resolve);
        });
    });
}
exports.parseDotCabal = parseDotCabal;
function getComponentFromFile(cabalSource, filePath) {
    return __awaiter(this, void 0, void 0, function* () {
        const fp = process.platform === 'win32'
            ? filePath.replace(path.sep, path.posix.sep)
            : filePath;
        return new Promise((resolve) => {
            HS.getComponentFromFile(cabalSource, fp, resolve);
        });
    });
}
exports.getComponentFromFile = getComponentFromFile;
function unlit(filename, source) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => {
            HS.unlit(filename, source, (error, result) => {
                if (error) {
                    reject(new Error(error));
                }
                else if (result) {
                    resolve(result);
                }
                else {
                    reject(new Error('Unknown error when trying to run unlit'));
                }
            });
        });
    });
}
exports.unlit = unlit;
function isErrorResult(x) {
    return x && x.error && typeof x.error === 'string';
}
function parseHsModuleImports(source) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => {
            HS.parseHsModuleImports(source, (result) => {
                if (isErrorResult(result)) {
                    reject(new Error(result.error));
                }
                else {
                    resolve(result);
                }
            });
        });
    });
}
exports.parseHsModuleImports = parseHsModuleImports;
exports.hsEscapeString = HS.hsEscapeString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFDQSwrQkFBa0Q7QUFDbEQseUJBQXdCO0FBQ3hCLDZCQUE0QjtBQUU1QixvQkFBb0IsR0FBRztJQUVyQixNQUFNLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxPQUFPLElBQUksT0FBTyxHQUFHLENBQUMsT0FBTyxLQUFLLFVBQVUsQ0FBQTtBQUNoRSxDQUFDO0FBRUQsc0JBQXNCLENBQUM7SUFFckIsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFBO0FBQ3BCLENBQUM7QUFFRCxxQkFBNEIsR0FBMkM7SUFDckUsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDakIsTUFBTSxDQUFDLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUE7SUFDbkMsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLEdBQUcsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQztZQUNILE1BQU0sQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ3ZDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLEtBQUssQ0FBQTtRQUNkLENBQUM7SUFDSCxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsS0FBSyxDQUFBO0lBQ2QsQ0FBQztBQUNILENBQUM7QUFmRCxrQ0FlQztBQUVELDRCQUFtQyxJQUE2QjtJQUM5RCxJQUFJLEdBQUcsR0FBcUIsSUFBSSxDQUFBO0lBQ2hDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDVCxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDakYsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNULEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3hDLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDN0MsR0FBRyxHQUFHLElBQUksQ0FBQTtJQUNaLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1QsR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUN4QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixHQUFHLEdBQUcsSUFBSSxnQkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzFCLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQTtBQUNaLENBQUM7QUFuQkQsZ0RBbUJDO0FBRUQsdUJBQW9DLEdBQWM7O1FBQ2hELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBMEIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBQ2xHLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2YsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUNuQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNMLENBQUM7Q0FBQTtBQVJELHNDQVFDO0FBRUQsb0JBQWlDLEtBQXdDOztRQUN2RSx5QkFBK0IsQ0FBWTs7Z0JBQ3pDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFBQyxNQUFNLENBQUMsS0FBSyxDQUFBO2dCQUFDLENBQUM7Z0JBQ3hCLE1BQU0sQ0FBQyxDQUFDLE1BQU0sYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO1lBQ3hHLENBQUM7U0FBQTtRQUNELDJCQUFpQyxDQUFZOztnQkFDM0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUE7Z0JBQUMsQ0FBQztnQkFDeEIsTUFBTSxDQUFDLENBQUMsTUFBTSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssc0JBQXNCLENBQUMsQ0FBQTtZQUNoSCxDQUFDO1NBQUE7UUFDRCx5QkFBK0IsQ0FBWSxFQUFFLEtBQXlDOztnQkFDcEYsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxLQUFJLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMsRUFBRSxDQUFDO29CQUM5RCxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtnQkFDeEIsQ0FBQztnQkFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ25CLE1BQU0sQ0FBQyxDQUFDLENBQUE7Z0JBQ1YsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDTixNQUFNLENBQUMsSUFBSSxDQUFBO2dCQUNiLENBQUM7WUFDSCxDQUFDO1NBQUE7UUFDRCxJQUFJLElBQTZCLENBQUE7UUFDakMsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QixJQUFJLEdBQUcsSUFBSSxXQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUE7UUFDbEMsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLElBQUksR0FBRyxLQUFLLENBQUE7UUFDZCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sS0FBSyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDckMsSUFBSSxHQUFHLElBQUksV0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksR0FBRyxJQUFJLENBQUE7UUFDYixDQUFDO1FBQ0QsSUFBSSxHQUFxQixDQUFBO1FBQ3pCLEVBQUUsQ0FBQyxDQUFDLElBQUksSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLEdBQUcsR0FBRyxJQUFJLGdCQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUE7UUFDckMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sR0FBRyxHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUQsQ0FBQztRQUNELE1BQU0sU0FBUyxHQUFHLE1BQU0sZUFBZSxDQUFDLEdBQUcsRUFBRSxlQUFlLENBQUMsQ0FBQTtRQUM3RCxNQUFNLFdBQVcsR0FBRyxNQUFNLGVBQWUsQ0FBQyxHQUFHLEVBQUUsaUJBQWlCLENBQUMsQ0FBQTtRQUNqRSxHQUFHLEdBQUcsU0FBUyxJQUFJLFdBQVcsQ0FBQTtRQUM5QixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixHQUFHLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEMsQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUE7SUFDWixDQUFDO0NBQUE7QUExQ0QsZ0NBMENDO0FBRUQsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFRLENBQUE7QUFFNUMsdUJBQW9DLFdBQW1COztRQUNyRCxNQUFNLENBQUMsSUFBSSxPQUFPLENBQW1CLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDL0MsRUFBRSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDeEMsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0NBQUE7QUFKRCxzQ0FJQztBQUNELDhCQUEyQyxXQUFtQixFQUFFLFFBQWdCOztRQUM5RSxNQUFNLEVBQUUsR0FDTixPQUFPLENBQUMsUUFBUSxLQUFLLE9BQU87WUFDNUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztZQUM1QyxDQUFDLENBQUMsUUFBUSxDQUFBO1FBQ1osTUFBTSxDQUFDLElBQUksT0FBTyxDQUFXLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDdkMsRUFBRSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDbkQsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0NBQUE7QUFSRCxvREFRQztBQUNELGVBQTRCLFFBQWdCLEVBQUUsTUFBYzs7UUFDMUQsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFTLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzdDLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtnQkFDM0MsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztvQkFDVixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtnQkFDMUIsQ0FBQztnQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDbEIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNqQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNOLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDLENBQUE7Z0JBQzdELENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUFBO0FBWkQsc0JBWUM7QUFDRCx1QkFBdUIsQ0FBQztJQUV0QixNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLENBQUMsS0FBSyxLQUFLLFFBQVEsQ0FBQTtBQUNwRCxDQUFDO0FBQ0QsOEJBQTJDLE1BQWM7O1FBQ3ZELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBaUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckQsRUFBRSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO2dCQUN6QyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUMxQixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7Z0JBQ2pDLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ04sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNqQixDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FBQTtBQVZELG9EQVVDO0FBQ1ksMENBQWMsQ0FBTyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOiBuby1udWxsLWtleXdvcmQgbm8tdmFyLXJlcXVpcmVzXG5pbXBvcnQgeyBEaXJlY3RvcnksIEZpbGUsIFRleHRCdWZmZXIgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnXG5cbmZ1bmN0aW9uIGhhc0dldFBhdGgoZGlyKTogZGlyIGlzIERpcmVjdG9yeSB8IEZpbGUge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueVxuICByZXR1cm4gZGlyICYmIGRpci5nZXRQYXRoICYmIHR5cGVvZiBkaXIuZ2V0UGF0aCA9PT0gJ2Z1bmN0aW9uJ1xufVxuXG5mdW5jdGlvbiBpc1RleHRCdWZmZXIoeCk6IHggaXMgVGV4dEJ1ZmZlciB7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XG4gIHJldHVybiB4ICYmIHguZmlsZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNEaXJlY3RvcnkoZGlyOiBGaWxlIHwgRGlyZWN0b3J5IHwgc3RyaW5nIHwgbnVsbCB8IGFueSk6IGJvb2xlYW4ge1xuICBpZiAoZGlyID09PSBudWxsKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbiAgaWYgKGhhc0dldFBhdGgoZGlyKSkge1xuICAgIHJldHVybiBpc0RpcmVjdG9yeShkaXIuZ2V0UGF0aCgpKVxuICB9IGVsc2UgaWYgKHR5cGVvZiBkaXIgPT09ICdzdHJpbmcnKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBmcy5zdGF0U3luYyhkaXIpLmlzRGlyZWN0b3J5KClcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJvb3REaXJGYWxsYmFjayhmaWxlOiBGaWxlIHwgRGlyZWN0b3J5IHwgbnVsbCk6IERpcmVjdG9yeSB7XG4gIGxldCBkaXI6IERpcmVjdG9yeSB8IG51bGwgPSBudWxsXG4gIGlmIChmaWxlKSB7XG4gICAgW2Rpcl0gPSBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKS5maWx0ZXIoKGQpID0+IGQuY29udGFpbnMoZmlsZS5nZXRQYXRoKCkpKVxuICB9XG4gIGlmICghZGlyKSB7XG4gICAgZGlyID0gYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKClbMF1cbiAgfVxuICBpZiAoZGlyICYmIGRpci5nZXRQYXRoKCkgPT09ICdhdG9tOi8vY29uZmlnJykge1xuICAgIGRpciA9IG51bGxcbiAgfVxuICBpZiAoIShkaXIgJiYgaXNEaXJlY3RvcnkoZGlyKSkpIHtcbiAgICBpZiAoZmlsZSkge1xuICAgICAgZGlyID0gZmlsZS5nZXRQYXJlbnQoKVxuICAgIH0gZWxzZSB7XG4gICAgICBkaXIgPSBuZXcgRGlyZWN0b3J5KCcuJylcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGRpclxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RGlyRW50cmllcyhkaXI6IERpcmVjdG9yeSk6IFByb21pc2U8QXJyYXk8RGlyZWN0b3J5IHwgRmlsZT4+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPEFycmF5PERpcmVjdG9yeSB8IEZpbGU+PigocmVzb2x2ZSwgcmVqZWN0KSA9PiBkaXIuZ2V0RW50cmllcygoZXJyb3IsIGNvbnRlbnRzKSA9PiB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICByZWplY3QoZXJyb3IpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc29sdmUoY29udGVudHMpXG4gICAgfVxuICB9KSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJvb3REaXIoaW5wdXQ6IFRleHRCdWZmZXIgfCBGaWxlIHwgc3RyaW5nIHwgbnVsbCk6IFByb21pc2U8RGlyZWN0b3J5PiB7XG4gIGFzeW5jIGZ1bmN0aW9uIGRpckhhc0NhYmFsRmlsZShkOiBEaXJlY3RvcnkpIHtcbiAgICBpZiAoIWQpIHsgcmV0dXJuIGZhbHNlIH1cbiAgICByZXR1cm4gKGF3YWl0IGdldERpckVudHJpZXMoZCkpLnNvbWUoKGZpbGUpID0+IGZpbGUuaXNGaWxlKCkgJiYgZmlsZS5nZXRCYXNlTmFtZSgpLmVuZHNXaXRoKCcuY2FiYWwnKSlcbiAgfVxuICBhc3luYyBmdW5jdGlvbiBkaXJIYXNTYW5kYm94RmlsZShkOiBEaXJlY3RvcnkpIHtcbiAgICBpZiAoIWQpIHsgcmV0dXJuIGZhbHNlIH1cbiAgICByZXR1cm4gKGF3YWl0IGdldERpckVudHJpZXMoZCkpLnNvbWUoKGZpbGUpID0+IGZpbGUuaXNGaWxlKCkgJiYgZmlsZS5nZXRCYXNlTmFtZSgpID09PSAnY2FiYWwuc2FuZGJveC5jb25maWcnKVxuICB9XG4gIGFzeW5jIGZ1bmN0aW9uIGZpbmRQcm9qZWN0Um9vdChkOiBEaXJlY3RvcnksIGNoZWNrOiAoZDogRGlyZWN0b3J5KSA9PiBQcm9taXNlPGJvb2xlYW4+KSB7XG4gICAgd2hpbGUgKCEoZCAmJiBkLmlzUm9vdCAmJiBkLmlzUm9vdCgpIHx8ICFkIHx8IGF3YWl0IGNoZWNrKGQpKSkge1xuICAgICAgZCA9IGQgJiYgZC5nZXRQYXJlbnQoKVxuICAgIH1cbiAgICBpZiAoYXdhaXQgY2hlY2soZCkpIHtcbiAgICAgIHJldHVybiBkXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuICB9XG4gIGxldCBmaWxlOiBGaWxlIHwgRGlyZWN0b3J5IHwgbnVsbFxuICBpZiAoaXNUZXh0QnVmZmVyKGlucHV0KSkge1xuICAgIGZpbGUgPSBuZXcgRmlsZShpbnB1dC5nZXRQYXRoKCkpXG4gIH0gZWxzZSBpZiAoaGFzR2V0UGF0aChpbnB1dCkpIHtcbiAgICBmaWxlID0gaW5wdXRcbiAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7XG4gICAgZmlsZSA9IG5ldyBGaWxlKGlucHV0KVxuICB9IGVsc2Uge1xuICAgIGZpbGUgPSBudWxsXG4gIH1cbiAgbGV0IGRpcjogRGlyZWN0b3J5IHwgbnVsbFxuICBpZiAoZmlsZSAmJiBpc0RpcmVjdG9yeShmaWxlKSkge1xuICAgIGRpciA9IG5ldyBEaXJlY3RvcnkoZmlsZS5nZXRQYXRoKCkpXG4gIH0gZWxzZSB7XG4gICAgZGlyID0gZmlsZSAmJiBmaWxlLmdldFBhcmVudCgpIHx8IGdldFJvb3REaXJGYWxsYmFjayhmaWxlKVxuICB9XG4gIGNvbnN0IGNhYmFsUm9vdCA9IGF3YWl0IGZpbmRQcm9qZWN0Um9vdChkaXIsIGRpckhhc0NhYmFsRmlsZSlcbiAgY29uc3Qgc2FuZGJveFJvb3QgPSBhd2FpdCBmaW5kUHJvamVjdFJvb3QoZGlyLCBkaXJIYXNTYW5kYm94RmlsZSlcbiAgZGlyID0gY2FiYWxSb290IHx8IHNhbmRib3hSb290XG4gIGlmICghKGRpciAmJiBpc0RpcmVjdG9yeShkaXIpKSkge1xuICAgIGRpciA9IGdldFJvb3REaXJGYWxsYmFjayhmaWxlKVxuICB9XG4gIHJldHVybiBkaXJcbn1cblxuY29uc3QgSFMgPSByZXF1aXJlKCcuLi9ocy9ocy5taW4uanMnKSBhcyBJSFNcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBhcnNlRG90Q2FiYWwoY2FiYWxTb3VyY2U6IHN0cmluZyk6IFByb21pc2U8SURvdENhYmFsIHwgbnVsbD4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8SURvdENhYmFsIHwgbnVsbD4oKHJlc29sdmUpID0+IHtcbiAgICBIUy5wYXJzZURvdENhYmFsKGNhYmFsU291cmNlLCByZXNvbHZlKVxuICB9KVxufVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbXBvbmVudEZyb21GaWxlKGNhYmFsU291cmNlOiBzdHJpbmcsIGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gIGNvbnN0IGZwID1cbiAgICBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInXG4gICAgPyBmaWxlUGF0aC5yZXBsYWNlKHBhdGguc2VwLCBwYXRoLnBvc2l4LnNlcClcbiAgICA6IGZpbGVQYXRoXG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmdbXT4oKHJlc29sdmUpID0+IHtcbiAgICBIUy5nZXRDb21wb25lbnRGcm9tRmlsZShjYWJhbFNvdXJjZSwgZnAsIHJlc29sdmUpXG4gIH0pXG59XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdW5saXQoZmlsZW5hbWU6IHN0cmluZywgc291cmNlOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgSFMudW5saXQoZmlsZW5hbWUsIHNvdXJjZSwgKGVycm9yLCByZXN1bHQpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSlcbiAgICAgIH0gZWxzZSBpZiAocmVzdWx0KSB7XG4gICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignVW5rbm93biBlcnJvciB3aGVuIHRyeWluZyB0byBydW4gdW5saXQnKSlcbiAgICAgIH1cbiAgICB9KVxuICB9KVxufVxuZnVuY3Rpb24gaXNFcnJvclJlc3VsdCh4KTogeCBpcyB7IGVycm9yOiBzdHJpbmcgfSB7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XG4gIHJldHVybiB4ICYmIHguZXJyb3IgJiYgdHlwZW9mIHguZXJyb3IgPT09ICdzdHJpbmcnXG59XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFyc2VIc01vZHVsZUltcG9ydHMoc291cmNlOiBzdHJpbmcpOiBQcm9taXNlPElNb2R1bGVJbXBvcnRzPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxJTW9kdWxlSW1wb3J0cz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIEhTLnBhcnNlSHNNb2R1bGVJbXBvcnRzKHNvdXJjZSwgKHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKGlzRXJyb3JSZXN1bHQocmVzdWx0KSkge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKHJlc3VsdC5lcnJvcikpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKHJlc3VsdClcbiAgICAgIH1cbiAgICB9KVxuICB9KVxufVxuZXhwb3J0IGxldCB7IGhzRXNjYXBlU3RyaW5nIH0gPSBIU1xuXG5leHBvcnQgaW50ZXJmYWNlIElUYXJnZXQge1xuICB0eXBlOiAnbGlicmFyeScgfCAnZXhlY3V0YWJsZScgfCAndGVzdC1zdWl0ZScgfCAnYmVuY2htYXJrJ1xuICBuYW1lOiBzdHJpbmdcbiAgdGFyZ2V0OiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRG90Q2FiYWwge1xuICBuYW1lOiBzdHJpbmdcbiAgdmVyc2lvbjogc3RyaW5nXG4gIHRhcmdldHM6IElUYXJnZXRbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElJbXBvcnQge1xuICBuYW1lOiBzdHJpbmdcbiAgcXVhbGlmaWVkOiBib29sZWFuXG4gIGhpZGluZzogYm9vbGVhblxuICBpbXBvcnRMaXN0OiBudWxsIHwgQXJyYXk8c3RyaW5nIHwgeyBwYXJlbnQ6IHN0cmluZyB9PlxuICBhbGlhczogbnVsbCB8IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElNb2R1bGVJbXBvcnRzIHtcbiAgbmFtZTogc3RyaW5nXG4gIGltcG9ydHM6IElJbXBvcnRbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElIUyB7XG4gIHBhcnNlRG90Q2FiYWwoY2FiYWxTb3VyY2U6IHN0cmluZywgY2FsbGJhY2s6IChyZXN1bHQ6IElEb3RDYWJhbCB8IG51bGwpID0+IHZvaWQpOiB2b2lkXG4gIHBhcnNlRG90Q2FiYWxTeW5jKGNhYmFsU291cmNlOiBzdHJpbmcpOiBJRG90Q2FiYWxcbiAgZ2V0Q29tcG9uZW50RnJvbUZpbGUoY2FiYWxTb3VyY2U6IHN0cmluZywgZmlsZVBhdGg6IHN0cmluZywgY2FsbGJhY2s6IChyZXN1bHQ6IHN0cmluZ1tdKSA9PiB2b2lkKTogdm9pZFxuICBnZXRDb21wb25lbnRGcm9tRmlsZVN5bmMoY2FiYWxTb3VyY2U6IHN0cmluZywgZmlsZVBhdGg6IHN0cmluZyk6IHN0cmluZ1tdXG4gIHVubGl0KFxuICAgIGZpbGVuYW1lOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nLFxuICAgIGNhbGxiYWNrOiAoXG4gICAgICBlcnJvcjogbnVsbCB8IHN0cmluZyxcbiAgICAgIHJlc3VsdDogbnVsbCB8IHN0cmluZyxcbiAgICApID0+IHZvaWQsXG4gICk6IHZvaWRcbiAgdW5saXRTeW5jKGZpbGVuYW1lOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nKTogc3RyaW5nIHwgeyBlcnJvcjogc3RyaW5nIH1cbiAgcGFyc2VIc01vZHVsZUltcG9ydHMoc291cmNlOiBzdHJpbmcsIGNhbGxiYWNrOiAocmVzdWx0OiB7IGVycm9yOiBzdHJpbmcgfSB8IElNb2R1bGVJbXBvcnRzKSA9PiB2b2lkKTogdm9pZFxuICBwYXJzZUhzTW9kdWxlSW1wb3J0c1N5bmMoc291cmNlOiBzdHJpbmcpOiBJTW9kdWxlSW1wb3J0c1xuICBoc0VzY2FwZVN0cmluZyhpbnB1dDogc3RyaW5nKTogc3RyaW5nXG59XG4iXX0=