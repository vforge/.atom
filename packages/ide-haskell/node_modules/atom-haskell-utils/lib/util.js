"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const fs = require("fs");
function hasGetPath(dir) {
    return dir && dir.getPath && typeof dir.getPath === 'function';
}
function isTextBuffer(x) {
    return x && x.file;
}
function isDirectory(dir) {
    if (dir === null) {
        return false;
    }
    if (hasGetPath(dir)) {
        return isDirectory(dir.getPath());
    }
    else if (typeof dir === 'string') {
        try {
            return fs.statSync(dir).isDirectory();
        }
        catch (e) {
            return false;
        }
    }
    else {
        return false;
    }
}
exports.isDirectory = isDirectory;
function getRootDirFallback(file) {
    let dir = null;
    if (file) {
        [dir] = atom.project.getDirectories().filter((d) => d.contains(file.getPath()));
    }
    if (!dir) {
        dir = atom.project.getDirectories()[0];
    }
    if (dir && dir.getPath() === 'atom://config') {
        dir = null;
    }
    if (!(dir && isDirectory(dir))) {
        if (file) {
            dir = file.getParent();
        }
        else {
            dir = new atom_1.Directory('.');
        }
    }
    return dir;
}
exports.getRootDirFallback = getRootDirFallback;
function getDirEntries(dir) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => dir.getEntries((error, contents) => {
            if (error) {
                reject(error);
            }
            else {
                resolve(contents);
            }
        }));
    });
}
exports.getDirEntries = getDirEntries;
function getRootDir(input) {
    return __awaiter(this, void 0, void 0, function* () {
        function dirHasCabalFile(d) {
            return __awaiter(this, void 0, void 0, function* () {
                if (!d) {
                    return false;
                }
                return (yield getDirEntries(d)).some((file) => file.isFile() && file.getBaseName().endsWith('.cabal'));
            });
        }
        function dirHasSandboxFile(d) {
            return __awaiter(this, void 0, void 0, function* () {
                if (!d) {
                    return false;
                }
                return (yield getDirEntries(d)).some((file) => file.isFile() && file.getBaseName() === 'cabal.sandbox.config');
            });
        }
        function findProjectRoot(d, check) {
            return __awaiter(this, void 0, void 0, function* () {
                while (!(d && d.isRoot && d.isRoot() || !d || (yield check(d)))) {
                    d = d && d.getParent();
                }
                if (yield check(d)) {
                    return d;
                }
                else {
                    return null;
                }
            });
        }
        let file;
        if (isTextBuffer(input)) {
            file = new atom_1.File(input.getPath());
        }
        else if (hasGetPath(input)) {
            file = input;
        }
        else if (typeof input === 'string') {
            file = new atom_1.File(input);
        }
        else {
            file = null;
        }
        let dir;
        if (file && isDirectory(file)) {
            dir = new atom_1.Directory(file.getPath());
        }
        else {
            dir = file && file.getParent() || getRootDirFallback(file);
        }
        let cabalRoot = yield findProjectRoot(dir, dirHasCabalFile);
        let sandboxRoot = yield findProjectRoot(dir, dirHasSandboxFile);
        dir = cabalRoot || sandboxRoot;
        if (!(dir && isDirectory(dir))) {
            dir = getRootDirFallback(file);
        }
        return dir;
    });
}
exports.getRootDir = getRootDir;
const HS = require('../hs/hs.min.js');
function parseDotCabal(cabalSource) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve) => {
            HS.parseDotCabal(cabalSource, resolve);
        });
    });
}
exports.parseDotCabal = parseDotCabal;
function getComponentFromFile(cabalSource, filePath) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve) => {
            HS.getComponentFromFile(cabalSource, filePath, resolve);
        });
    });
}
exports.getComponentFromFile = getComponentFromFile;
function unlit(filename, source) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => {
            HS.unlit(filename, source, (error, result) => {
                if (error) {
                    reject(new Error(error));
                }
                else if (result) {
                    resolve(result);
                }
                else {
                    reject(new Error('Unknown error when trying to run unlit'));
                }
            });
        });
    });
}
exports.unlit = unlit;
function isErrorResult(x) {
    return x && x.error && typeof x.error === 'string';
}
function parseHsModuleImports(source) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((resolve, reject) => {
            HS.parseHsModuleImports(source, (result) => {
                if (isErrorResult(result)) {
                    reject(new Error(result.error));
                }
                else {
                    resolve(result);
                }
            });
        });
    });
}
exports.parseHsModuleImports = parseHsModuleImports;
exports.hsEscapeString = HS.hsEscapeString;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSwrQkFBZ0Q7QUFDaEQseUJBQXdCO0FBRXhCLG9CQUFxQixHQUFHO0lBQ3RCLE1BQU0sQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sSUFBSSxPQUFPLEdBQUcsQ0FBQyxPQUFPLEtBQUssVUFBVSxDQUFBO0FBQ2hFLENBQUM7QUFFRCxzQkFBdUIsQ0FBQztJQUN0QixNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUE7QUFDcEIsQ0FBQztBQUVELHFCQUE2QixHQUFxQztJQUNoRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNqQixNQUFNLENBQUMsS0FBSyxDQUFBO0lBQ2QsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sR0FBRyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDdkMsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDWCxNQUFNLENBQUMsS0FBSyxDQUFBO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sQ0FBQyxLQUFLLENBQUE7SUFDZCxDQUFDO0FBQ0gsQ0FBQztBQWZELGtDQWVDO0FBRUQsNEJBQW9DLElBQTZCO0lBQy9ELElBQUksR0FBRyxHQUFx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eHRCdWZmZXJ9IGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcblxuZnVuY3Rpb24gaGFzR2V0UGF0aCAoZGlyKTogZGlyIGlzIERpcmVjdG9yeSB8IEZpbGUge1xuICByZXR1cm4gZGlyICYmIGRpci5nZXRQYXRoICYmIHR5cGVvZiBkaXIuZ2V0UGF0aCA9PT0gJ2Z1bmN0aW9uJ1xufVxuXG5mdW5jdGlvbiBpc1RleHRCdWZmZXIgKHgpOiB4IGlzIFRleHRCdWZmZXIge1xuICByZXR1cm4geCAmJiB4LmZpbGVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRGlyZWN0b3J5IChkaXI6IEZpbGUgfCBEaXJlY3RvcnkgfCBzdHJpbmcgfCBudWxsKTogYm9vbGVhbiB7XG4gIGlmIChkaXIgPT09IG51bGwpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICBpZiAoaGFzR2V0UGF0aChkaXIpKSB7XG4gICAgcmV0dXJuIGlzRGlyZWN0b3J5KGRpci5nZXRQYXRoKCkpXG4gIH0gZWxzZSBpZiAodHlwZW9mIGRpciA9PT0gJ3N0cmluZycpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGZzLnN0YXRTeW5jKGRpcikuaXNEaXJlY3RvcnkoKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Um9vdERpckZhbGxiYWNrIChmaWxlOiBGaWxlIHwgRGlyZWN0b3J5IHwgbnVsbCk6IERpcmVjdG9yeSB7XG4gIGxldCBkaXI6IERpcmVjdG9yeSB8IG51bGwgPSBudWxsXG4gIGlmIChmaWxlKSB7XG4gICAgW2Rpcl0gPSBhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKS5maWx0ZXIoKGQpID0+IGQuY29udGFpbnMoZmlsZS5nZXRQYXRoKCkpKVxuICB9XG4gIGlmICghZGlyKSB7XG4gICAgZGlyID0gYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKClbMF1cbiAgfVxuICBpZiAoZGlyICYmIGRpci5nZXRQYXRoKCkgPT09ICdhdG9tOi8vY29uZmlnJykge1xuICAgIGRpciA9IG51bGxcbiAgfVxuICBpZiAoIShkaXIgJiYgaXNEaXJlY3RvcnkoZGlyKSkpIHtcbiAgICBpZiAoZmlsZSkge1xuICAgICAgZGlyID0gZmlsZS5nZXRQYXJlbnQoKVxuICAgIH0gZWxzZSB7XG4gICAgICBkaXIgPSBuZXcgRGlyZWN0b3J5KCcuJylcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGRpclxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RGlyRW50cmllcyAoZGlyOiBEaXJlY3RvcnkpOiBQcm9taXNlPEFycmF5PERpcmVjdG9yeXxGaWxlPj4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8QXJyYXk8RGlyZWN0b3J5fEZpbGU+PigocmVzb2x2ZSwgcmVqZWN0KSA9PiBkaXIuZ2V0RW50cmllcygoZXJyb3IsIGNvbnRlbnRzKSA9PiB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICByZWplY3QoZXJyb3IpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc29sdmUoY29udGVudHMpXG4gICAgfVxuICB9KSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJvb3REaXIgKGlucHV0OiBUZXh0QnVmZmVyIHwgRmlsZSB8IHN0cmluZyB8IG51bGwpOiBQcm9taXNlPERpcmVjdG9yeT4ge1xuICBhc3luYyBmdW5jdGlvbiBkaXJIYXNDYWJhbEZpbGUgKGQ6IERpcmVjdG9yeSkge1xuICAgIGlmICghZCkge3JldHVybiBmYWxzZX1cbiAgICByZXR1cm4gKGF3YWl0IGdldERpckVudHJpZXMoZCkpLnNvbWUoKGZpbGUpID0+IGZpbGUuaXNGaWxlKCkgJiYgZmlsZS5nZXRCYXNlTmFtZSgpLmVuZHNXaXRoKCcuY2FiYWwnKSlcbiAgfVxuICBhc3luYyBmdW5jdGlvbiBkaXJIYXNTYW5kYm94RmlsZSAoZDogRGlyZWN0b3J5KSB7XG4gICAgaWYgKCFkKSB7cmV0dXJuIGZhbHNlfVxuICAgIHJldHVybiAoYXdhaXQgZ2V0RGlyRW50cmllcyhkKSkuc29tZSgoZmlsZSkgPT4gZmlsZS5pc0ZpbGUoKSAmJiBmaWxlLmdldEJhc2VOYW1lKCkgPT09ICdjYWJhbC5zYW5kYm94LmNvbmZpZycpXG4gIH1cbiAgYXN5bmMgZnVuY3Rpb24gZmluZFByb2plY3RSb290IChkOiBEaXJlY3RvcnksIGNoZWNrOiAoZDogRGlyZWN0b3J5KSA9PiBQcm9taXNlPGJvb2xlYW4+KSB7XG4gICAgd2hpbGUgKCEoZCAmJiBkLmlzUm9vdCAmJiBkLmlzUm9vdCgpIHx8ICFkIHx8IGF3YWl0IGNoZWNrKGQpKSkge1xuICAgICAgZCA9IGQgJiYgZC5nZXRQYXJlbnQoKVxuICAgIH1cbiAgICBpZiAoYXdhaXQgY2hlY2soZCkpIHtcbiAgICAgIHJldHVybiBkXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuICB9XG4gIGxldCBmaWxlOiBGaWxlIHwgRGlyZWN0b3J5IHwgbnVsbFxuICBpZiAoaXNUZXh0QnVmZmVyKGlucHV0KSkge1xuICAgIGZpbGUgPSBuZXcgRmlsZShpbnB1dC5nZXRQYXRoKCkpXG4gIH0gZWxzZSBpZiAoaGFzR2V0UGF0aChpbnB1dCkpIHtcbiAgICBmaWxlID0gaW5wdXRcbiAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7XG4gICAgZmlsZSA9IG5ldyBGaWxlKGlucHV0KVxuICB9IGVsc2Uge1xuICAgIGZpbGUgPSBudWxsXG4gIH1cbiAgbGV0IGRpcjogRGlyZWN0b3J5IHwgbnVsbFxuICBpZiAoZmlsZSAmJiBpc0RpcmVjdG9yeShmaWxlKSkge1xuICAgIGRpciA9IG5ldyBEaXJlY3RvcnkoZmlsZS5nZXRQYXRoKCkpXG4gIH0gZWxzZSB7XG4gICAgZGlyID0gZmlsZSAmJiBmaWxlLmdldFBhcmVudCgpIHx8IGdldFJvb3REaXJGYWxsYmFjayhmaWxlKVxuICB9XG4gIGxldCBjYWJhbFJvb3QgPSBhd2FpdCBmaW5kUHJvamVjdFJvb3QoZGlyLCBkaXJIYXNDYWJhbEZpbGUpXG4gIGxldCBzYW5kYm94Um9vdCA9IGF3YWl0IGZpbmRQcm9qZWN0Um9vdChkaXIsIGRpckhhc1NhbmRib3hGaWxlKVxuICBkaXIgPSBjYWJhbFJvb3QgfHwgc2FuZGJveFJvb3RcbiAgaWYgKCEoZGlyICYmIGlzRGlyZWN0b3J5KGRpcikpKSB7XG4gICAgZGlyID0gZ2V0Um9vdERpckZhbGxiYWNrKGZpbGUpXG4gIH1cbiAgcmV0dXJuIGRpclxufVxuXG5jb25zdCBIUyA9IHJlcXVpcmUoJy4uL2hzL2hzLm1pbi5qcycpIGFzIElIU1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFyc2VEb3RDYWJhbCAoY2FiYWxTb3VyY2U6IHN0cmluZyk6IFByb21pc2U8SURvdENhYmFsIHwgbnVsbD4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8SURvdENhYmFsIHwgbnVsbD4oKHJlc29sdmUpID0+IHtcbiAgICBIUy5wYXJzZURvdENhYmFsKGNhYmFsU291cmNlLCByZXNvbHZlKVxuICB9KVxufVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbXBvbmVudEZyb21GaWxlIChjYWJhbFNvdXJjZTogc3RyaW5nLCBmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nW10+KChyZXNvbHZlKSA9PiB7XG4gICAgSFMuZ2V0Q29tcG9uZW50RnJvbUZpbGUoY2FiYWxTb3VyY2UsIGZpbGVQYXRoLCByZXNvbHZlKVxuICB9KVxufVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVubGl0IChmaWxlbmFtZTogc3RyaW5nLCBzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBIUy51bmxpdChmaWxlbmFtZSwgc291cmNlLCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoZXJyb3IpKVxuICAgICAgfSBlbHNlIGlmIChyZXN1bHQpIHtcbiAgICAgICAgcmVzb2x2ZShyZXN1bHQpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKCdVbmtub3duIGVycm9yIHdoZW4gdHJ5aW5nIHRvIHJ1biB1bmxpdCcpKVxuICAgICAgfVxuICAgIH0pXG4gIH0pXG59XG5mdW5jdGlvbiBpc0Vycm9yUmVzdWx0ICh4KTogeCBpcyB7ZXJyb3I6IHN0cmluZ30ge1xuICByZXR1cm4geCAmJiB4LmVycm9yICYmIHR5cGVvZiB4LmVycm9yID09PSAnc3RyaW5nJ1xufVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBhcnNlSHNNb2R1bGVJbXBvcnRzIChzb3VyY2U6IHN0cmluZyk6IFByb21pc2U8SU1vZHVsZUltcG9ydHM+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPElNb2R1bGVJbXBvcnRzPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgSFMucGFyc2VIc01vZHVsZUltcG9ydHMoc291cmNlLCAocmVzdWx0KSA9PiB7XG4gICAgICBpZiAoaXNFcnJvclJlc3VsdChyZXN1bHQpKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IocmVzdWx0LmVycm9yKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgfVxuICAgIH0pXG4gIH0pXG59XG5leHBvcnQgbGV0IHtoc0VzY2FwZVN0cmluZ30gPSBIU1xuXG5leHBvcnQgaW50ZXJmYWNlIElUYXJnZXQge1xuICB0eXBlOiAnbGlicmFyeScgfCAnZXhlY3V0YWJsZScgfCAndGVzdC1zdWl0ZScgfCAnYmVuY2htYXJrJ1xuICBuYW1lOiBzdHJpbmdcbiAgdGFyZ2V0OiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRG90Q2FiYWwge1xuICBuYW1lOiBzdHJpbmdcbiAgdmVyc2lvbjogc3RyaW5nXG4gIHRhcmdldHM6IElUYXJnZXRbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElJbXBvcnQge1xuICBuYW1lOiBzdHJpbmdcbiAgcXVhbGlmaWVkOiBib29sZWFuXG4gIGhpZGluZzogYm9vbGVhblxuICBpbXBvcnRMaXN0OiBudWxsIHwgQXJyYXk8c3RyaW5nIHwge3BhcmVudDogc3RyaW5nfT5cbiAgYWxpYXM6IG51bGwgfCBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTW9kdWxlSW1wb3J0cyB7XG4gIG5hbWU6IHN0cmluZ1xuICBpbXBvcnRzOiBJSW1wb3J0W11cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJSFMge1xuICBwYXJzZURvdENhYmFsIChjYWJhbFNvdXJjZTogc3RyaW5nLCBjYWxsYmFjazogKHJlc3VsdDogSURvdENhYmFsIHwgbnVsbCkgPT4gdm9pZCk6IHZvaWRcbiAgcGFyc2VEb3RDYWJhbFN5bmMgKGNhYmFsU291cmNlOiBzdHJpbmcpOiBJRG90Q2FiYWxcbiAgZ2V0Q29tcG9uZW50RnJvbUZpbGUgKGNhYmFsU291cmNlOiBzdHJpbmcsIGZpbGVQYXRoOiBzdHJpbmcsIGNhbGxiYWNrOiAocmVzdWx0OiBzdHJpbmdbXSkgPT4gdm9pZCk6IHZvaWRcbiAgZ2V0Q29tcG9uZW50RnJvbUZpbGVTeW5jIChjYWJhbFNvdXJjZTogc3RyaW5nLCBmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nW11cbiAgdW5saXQgKFxuICAgIGZpbGVuYW1lOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nLFxuICAgIGNhbGxiYWNrOiAoXG4gICAgICBlcnJvcjogbnVsbCB8IHN0cmluZyxcbiAgICAgIHJlc3VsdDogbnVsbCB8IHN0cmluZyxcbiAgICApID0+IHZvaWQsXG4gICk6IHZvaWRcbiAgdW5saXRTeW5jIChmaWxlbmFtZTogc3RyaW5nLCBzb3VyY2U6IHN0cmluZyk6IHN0cmluZyB8IHtlcnJvcjogc3RyaW5nfVxuICBwYXJzZUhzTW9kdWxlSW1wb3J0cyAoc291cmNlOiBzdHJpbmcsIGNhbGxiYWNrOiAocmVzdWx0OiB7ZXJyb3I6IHN0cmluZ30gfCBJTW9kdWxlSW1wb3J0cykgPT4gdm9pZCk6IHZvaWRcbiAgcGFyc2VIc01vZHVsZUltcG9ydHNTeW5jIChzb3VyY2U6IHN0cmluZyk6IElNb2R1bGVJbXBvcnRzXG4gIGhzRXNjYXBlU3RyaW5nIChpbnB1dDogc3RyaW5nKTogc3RyaW5nXG59XG4iXX0=