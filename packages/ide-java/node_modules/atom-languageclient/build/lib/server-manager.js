Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ServerManager = undefined;

require('./logger');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _languageclient = require('./languageclient');

var ls = _interopRequireWildcard(_languageclient);

var _convert = require('./convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Manages the language server lifecycles and their associated objects necessary
// for adapting them to Atom IDE.


// The necessary elements for a server that has started or is starting.
class ServerManager {

  constructor(startServer, logger, startForEditor) {
    this._activeServers = [];
    this._startingServerPromises = new Map();
    this._stoppingServers = [];
    this._disposable = new _atom.CompositeDisposable();
    this._editorToServer = new Map();
    this._normalizedProjectPaths = [];

    this._startServer = startServer;
    this._logger = logger;
    this._startForEditor = startForEditor;
    this.updateNormalizedProjectPaths();
  }

  startListening() {
    this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
    this._disposable.add(atom.project.onDidChangePaths(this.projectPathsChanged.bind(this)));
    if (atom.project.onDidChangeFiles) {
      this._disposable.add(atom.project.onDidChangeFiles(this.projectFilesChanged.bind(this)));
    }
  }

  stopListening() {
    this._disposable.dispose();
  }

  observeTextEditors(editor) {
    // Track grammar changes for opened editors
    const listener = editor.observeGrammar(grammar => this._handleGrammarChange(editor));
    this._disposable.add(editor.onDidDestroy(() => listener.dispose()));
    // Try to see if editor can have LS connected to it
    this._handleTextEditor(editor);
  }

  async _handleTextEditor(editor) {
    if (!this._editorToServer.has(editor)) {
      // editor hasn't been processed yet, so process it by allocating LS for it if necessary
      const server = await this.getServer(editor, { shouldStart: true });
      if (server != null) {
        // There LS for the editor (either started now and already running)
        this._editorToServer.set(editor, server);
        this._disposable.add(editor.onDidDestroy(() => {
          this._editorToServer.delete(editor);
          this.stopUnusedServers();
        }));
      }
    }
  }

  _handleGrammarChange(editor) {
    if (this._startForEditor(editor)) {
      // If editor is interesting for LS process the editor further to attempt to start LS if needed
      this._handleTextEditor(editor);
    } else {
      // Editor is not supported by the LS
      const server = this._editorToServer.get(editor);
      // If LS is running for the unsupported editor then disconnect the editor from LS and shut down LS if necessary
      if (server) {
        // LS is up for unsupported server
        if (server.docSyncAdapter) {
          const syncAdapter = server.docSyncAdapter.getEditorSyncAdapter(editor);
          if (syncAdapter) {
            // Immitate editor close to disconnect LS from the editor
            syncAdapter.didClose();
          }
        }
        // Remove editor from the cache
        this._editorToServer.delete(editor);
        // Shut down LS if it's used by any other editor
        this.stopUnusedServers();
      }
    }
  }

  getActiveServers() {
    return this._activeServers.slice();
  }

  async getServer(textEditor, { shouldStart } = { shouldStart: false }) {
    const finalProjectPath = this.determineProjectPath(textEditor);
    if (finalProjectPath == null) {
      // Files not yet saved have no path
      return null;
    }

    const foundActiveServer = this._activeServers.find(s => finalProjectPath === s.projectPath);
    if (foundActiveServer) {
      return foundActiveServer;
    }

    const startingPromise = this._startingServerPromises.get(finalProjectPath);
    if (startingPromise) {
      return startingPromise;
    }

    return shouldStart && this._startForEditor(textEditor) ? await this.startServer(finalProjectPath) : null;
  }

  async startServer(projectPath) {
    this._logger.debug(`Server starting "${projectPath}"`);
    const startingPromise = this._startServer(projectPath);
    this._startingServerPromises.set(projectPath, startingPromise);
    const startedActiveServer = await startingPromise;
    this._activeServers.push(startedActiveServer);
    this._startingServerPromises.delete(projectPath);
    this._logger.debug(`Server started "${projectPath}" (pid ${startedActiveServer.process.pid})`);
    return startedActiveServer;
  }

  async stopUnusedServers() {
    const usedServers = new Set(this._editorToServer.values());
    const unusedServers = this._activeServers.filter(s => !usedServers.has(s));
    if (unusedServers.length > 0) {
      this._logger.debug(`Stopping ${unusedServers.length} unused servers`);
      await Promise.all(unusedServers.map(s => this.stopServer(s)));
    }
  }

  async stopAllServers() {
    await Promise.all(this._activeServers.map(s => this.stopServer(s)));
  }

  async stopServer(server) {
    this._logger.debug(`Server stopping "${server.projectPath}"`);
    // Immediately remove the server to prevent further usage.
    // If we re-open the file after this point, we'll get a new server.
    this._activeServers.splice(this._activeServers.indexOf(server), 1);
    this._stoppingServers.push(server);
    server.disposable.dispose();
    await server.connection.shutdown();

    if (server.linterPushV2 != null) {
      server.linterPushV2.detachAll();
    }

    if (server.signatureHelpAdapter != null) {
      server.signatureHelpAdapter.dispose();
    }

    this.exitServer(server);
    this._stoppingServers.splice(this._stoppingServers.indexOf(server), 1);
  }

  exitServer(server) {
    const pid = server.process.pid;
    try {
      server.connection.exit();
    } finally {
      server.process.kill();
    }
    this._logger.debug(`Server stopped "${server.projectPath}" (pid ${pid})`);
  }

  terminate() {
    this._stoppingServers.forEach(server => {
      this._logger.debug(`Server terminating "${server.projectPath}"`);
      this.exitServer(server);
    });
  }

  determineProjectPath(textEditor) {
    const filePath = textEditor.getPath();
    if (filePath == null) {
      return null;
    }
    return this._normalizedProjectPaths.find(d => filePath.startsWith(d));
  }

  updateNormalizedProjectPaths() {
    this._normalizedProjectPaths = atom.project.getDirectories().map(d => this.normalizePath(d.getPath()));
  }

  normalizePath(projectPath) {
    return !projectPath.endsWith(_path2.default.sep) ? _path2.default.join(projectPath, _path2.default.sep) : projectPath;
  }

  projectPathsChanged(projectPaths) {
    const pathsSet = new Set(projectPaths.map(this.normalizePath));
    const serversToStop = this._activeServers.filter(s => !pathsSet.has(s.projectPath));
    Promise.all(serversToStop.map(s => this.stopServer(s)));
    this.updateNormalizedProjectPaths();
  }

  projectFilesChanged(fileEvents) {
    if (this._activeServers.length === 0) {
      return;
    }

    for (const activeServer of this._activeServers) {
      const changes = [];
      for (const fileEvent of fileEvents) {
        if (fileEvent.path.startsWith(activeServer.projectPath)) {
          changes.push(_convert2.default.atomFileEventToLSFileEvents(fileEvent)[0]);
        }
        if (fileEvent.oldPath && fileEvent.oldPath.startsWith(activeServer.projectPath)) {
          changes.push(_convert2.default.atomFileEventToLSFileEvents(fileEvent)[1]);
        }
      }
      if (changes.length > 0) {
        activeServer.connection.didChangeWatchedFiles({ changes });
      }
    }
  }
}
exports.ServerManager = ServerManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2ZXItbWFuYWdlci5qcyJdLCJuYW1lcyI6WyJscyIsIlNlcnZlck1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsInN0YXJ0U2VydmVyIiwibG9nZ2VyIiwic3RhcnRGb3JFZGl0b3IiLCJfYWN0aXZlU2VydmVycyIsIl9zdGFydGluZ1NlcnZlclByb21pc2VzIiwiTWFwIiwiX3N0b3BwaW5nU2VydmVycyIsIl9kaXNwb3NhYmxlIiwiX2VkaXRvclRvU2VydmVyIiwiX25vcm1hbGl6ZWRQcm9qZWN0UGF0aHMiLCJfc3RhcnRTZXJ2ZXIiLCJfbG9nZ2VyIiwiX3N0YXJ0Rm9yRWRpdG9yIiwidXBkYXRlTm9ybWFsaXplZFByb2plY3RQYXRocyIsInN0YXJ0TGlzdGVuaW5nIiwiYWRkIiwiYXRvbSIsInRleHRFZGl0b3JzIiwib2JzZXJ2ZSIsIm9ic2VydmVUZXh0RWRpdG9ycyIsImJpbmQiLCJwcm9qZWN0Iiwib25EaWRDaGFuZ2VQYXRocyIsInByb2plY3RQYXRoc0NoYW5nZWQiLCJvbkRpZENoYW5nZUZpbGVzIiwicHJvamVjdEZpbGVzQ2hhbmdlZCIsInN0b3BMaXN0ZW5pbmciLCJkaXNwb3NlIiwiZWRpdG9yIiwibGlzdGVuZXIiLCJvYnNlcnZlR3JhbW1hciIsImdyYW1tYXIiLCJfaGFuZGxlR3JhbW1hckNoYW5nZSIsIm9uRGlkRGVzdHJveSIsIl9oYW5kbGVUZXh0RWRpdG9yIiwiaGFzIiwic2VydmVyIiwiZ2V0U2VydmVyIiwic2hvdWxkU3RhcnQiLCJzZXQiLCJkZWxldGUiLCJzdG9wVW51c2VkU2VydmVycyIsImdldCIsImRvY1N5bmNBZGFwdGVyIiwic3luY0FkYXB0ZXIiLCJnZXRFZGl0b3JTeW5jQWRhcHRlciIsImRpZENsb3NlIiwiZ2V0QWN0aXZlU2VydmVycyIsInNsaWNlIiwidGV4dEVkaXRvciIsImZpbmFsUHJvamVjdFBhdGgiLCJkZXRlcm1pbmVQcm9qZWN0UGF0aCIsImZvdW5kQWN0aXZlU2VydmVyIiwiZmluZCIsInMiLCJwcm9qZWN0UGF0aCIsInN0YXJ0aW5nUHJvbWlzZSIsImRlYnVnIiwic3RhcnRlZEFjdGl2ZVNlcnZlciIsInB1c2giLCJwcm9jZXNzIiwicGlkIiwidXNlZFNlcnZlcnMiLCJTZXQiLCJ2YWx1ZXMiLCJ1bnVzZWRTZXJ2ZXJzIiwiZmlsdGVyIiwibGVuZ3RoIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsInN0b3BTZXJ2ZXIiLCJzdG9wQWxsU2VydmVycyIsInNwbGljZSIsImluZGV4T2YiLCJkaXNwb3NhYmxlIiwiY29ubmVjdGlvbiIsInNodXRkb3duIiwibGludGVyUHVzaFYyIiwiZGV0YWNoQWxsIiwic2lnbmF0dXJlSGVscEFkYXB0ZXIiLCJleGl0U2VydmVyIiwiZXhpdCIsImtpbGwiLCJ0ZXJtaW5hdGUiLCJmb3JFYWNoIiwiZmlsZVBhdGgiLCJnZXRQYXRoIiwiZCIsInN0YXJ0c1dpdGgiLCJnZXREaXJlY3RvcmllcyIsIm5vcm1hbGl6ZVBhdGgiLCJlbmRzV2l0aCIsInNlcCIsImpvaW4iLCJwcm9qZWN0UGF0aHMiLCJwYXRoc1NldCIsInNlcnZlcnNUb1N0b3AiLCJmaWxlRXZlbnRzIiwiYWN0aXZlU2VydmVyIiwiY2hhbmdlcyIsImZpbGVFdmVudCIsInBhdGgiLCJhdG9tRmlsZUV2ZW50VG9MU0ZpbGVFdmVudHMiLCJvbGRQYXRoIiwiZGlkQ2hhbmdlV2F0Y2hlZEZpbGVzIl0sIm1hcHBpbmdzIjoiOzs7OztBQUVBOztBQUtBOzs7O0FBQ0E7O0lBQVlBLEU7O0FBQ1o7Ozs7QUFDQTs7Ozs7O0FBY0E7QUFDQTs7O0FBYkE7QUFjTyxNQUFNQyxhQUFOLENBQW9COztBQVd6QkMsY0FDRUMsV0FERixFQUVFQyxNQUZGLEVBR0VDLGNBSEYsRUFJRTtBQUFBLFNBZEZDLGNBY0UsR0Fkb0MsRUFjcEM7QUFBQSxTQWJGQyx1QkFhRSxHQWI0RCxJQUFJQyxHQUFKLEVBYTVEO0FBQUEsU0FaRkMsZ0JBWUUsR0Fac0MsRUFZdEM7QUFBQSxTQVhGQyxXQVdFLEdBWGlDLCtCQVdqQztBQUFBLFNB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ZixDQUEwQlUsYUFBYTVDLFdBQXZDLENBQUosRUFBeUQ7QUFDdkQ2QyxrQkFBUXpDLElBQVIsQ0FBYSxrQkFBUTRDLDJCQUFSLENBQW9DRixTQUFwQyxFQUErQyxDQUEvQyxDQUFiO0FBQ0Q7QUFDRCxZQUFJQSxVQUFVRyxPQUFWLElBQXFCSCxVQUFVRyxPQUFWLENBQWtCZixVQUFsQixDQUE2QlUsYUFBYTVDLFdBQTFDLENBQXpCLEVBQWlGO0FBQy9FNkMsa0JBQVF6QyxJQUFSLENBQWEsa0JBQVE0QywyQkFBUixDQUFvQ0YsU0FBcEMsRUFBK0MsQ0FBL0MsQ0FBYjtBQUNEO0FBQ0Y7QUFDRCxVQUFJRCxRQUFRakMsTUFBUixHQUFpQixDQUFyQixFQUF3QjtBQUN0QmdDLHFCQUFhdkIsVUFBYixDQUF3QjZCLHFCQUF4QixDQUE4QyxFQUFDTCxPQUFELEVBQTlDO0FBQ0Q7QUFDRjtBQUNGO0FBdk53QjtRQUFkdEcsYSxHQUFBQSxhIiwiZmlsZSI6InNlcnZlci1tYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB7dHlwZSBMb2dnZXJ9IGZyb20gJy4vbG9nZ2VyJztcclxuaW1wb3J0IHR5cGUgTGludGVyUHVzaFYyQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL2xpbnRlci1wdXNoLXYyLWFkYXB0ZXInO1xyXG5pbXBvcnQgdHlwZSBEb2N1bWVudFN5bmNBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvZG9jdW1lbnQtc3luYy1hZGFwdGVyJztcclxuaW1wb3J0IHR5cGUgU2lnbmF0dXJlSGVscEFkYXB0ZXIgZnJvbSAnLi9hZGFwdGVycy9zaWduYXR1cmUtaGVscC1hZGFwdGVyJztcclxuXHJcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgKiBhcyBscyBmcm9tICcuL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi9jb252ZXJ0JztcclxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcclxuXHJcbi8vIFRoZSBuZWNlc3NhcnkgZWxlbWVudHMgZm9yIGEgc2VydmVyIHRoYXQgaGFzIHN0YXJ0ZWQgb3IgaXMgc3RhcnRpbmcuXHJcbmV4cG9ydCB0eXBlIEFjdGl2ZVNlcnZlciA9IHtcclxuICBkaXNwb3NhYmxlOiBDb21wb3NpdGVEaXNwb3NhYmxlLFxyXG4gIHByb2plY3RQYXRoOiBzdHJpbmcsXHJcbiAgcHJvY2VzczogY2hpbGRfcHJvY2VzcyRDaGlsZFByb2Nlc3MsXHJcbiAgY29ubmVjdGlvbjogbHMuTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLFxyXG4gIGNhcGFiaWxpdGllczogbHMuU2VydmVyQ2FwYWJpbGl0aWVzLFxyXG4gIGxpbnRlclB1c2hWMj86IExpbnRlclB1c2hWMkFkYXB0ZXIsXHJcbiAgZG9jU3luY0FkYXB0ZXI/OiBEb2N1bWVudFN5bmNBZGFwdGVyLFxyXG4gIHNpZ25hdHVyZUhlbHBBZGFwdGVyPzogU2lnbmF0dXJlSGVscEFkYXB0ZXIsXHJcbn07XHJcblxyXG4vLyBNYW5hZ2VzIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgbGlmZWN5Y2xlcyBhbmQgdGhlaXIgYXNzb2NpYXRlZCBvYmplY3RzIG5lY2Vzc2FyeVxyXG4vLyBmb3IgYWRhcHRpbmcgdGhlbSB0byBBdG9tIElERS5cclxuZXhwb3J0IGNsYXNzIFNlcnZlck1hbmFnZXIge1xyXG4gIF9hY3RpdmVTZXJ2ZXJzOiBBcnJheTxBY3RpdmVTZXJ2ZXI+ID0gW107XHJcbiAgX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXM6IE1hcDxzdHJpbmcsIFByb21pc2U8QWN0aXZlU2VydmVyPj4gPSBuZXcgTWFwKCk7XHJcbiAgX3N0b3BwaW5nU2VydmVyczogQXJyYXk8QWN0aXZlU2VydmVyPiA9IFtdO1xyXG4gIF9kaXNwb3NhYmxlOiBDb21wb3NpdGVEaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICBfZWRpdG9yVG9TZXJ2ZXI6IE1hcDxhdG9tJFRleHRFZGl0b3IsIEFjdGl2ZVNlcnZlcj4gPSBuZXcgTWFwKCk7XHJcbiAgX2xvZ2dlcjogTG9nZ2VyO1xyXG4gIF9ub3JtYWxpemVkUHJvamVjdFBhdGhzOiBBcnJheTxzdHJpbmc+ID0gW107XHJcbiAgX3N0YXJ0Rm9yRWRpdG9yOiAoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpID0+IGJvb2xlYW47XHJcbiAgX3N0YXJ0U2VydmVyOiAocHJvamVjdFBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTxBY3RpdmVTZXJ2ZXI+O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHN0YXJ0U2VydmVyOiAocHJvamVjdFBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTxBY3RpdmVTZXJ2ZXI+LFxyXG4gICAgbG9nZ2VyOiBMb2dnZXIsXHJcbiAgICBzdGFydEZvckVkaXRvcjogKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSA9PiBib29sZWFuLFxyXG4gICkge1xyXG4gICAgdGhpcy5fc3RhcnRTZXJ2ZXIgPSBzdGFydFNlcnZlcjtcclxuICAgIHRoaXMuX2xvZ2dlciA9IGxvZ2dlcjtcclxuICAgIHRoaXMuX3N0YXJ0Rm9yRWRpdG9yID0gc3RhcnRGb3JFZGl0b3I7XHJcbiAgICB0aGlzLnVwZGF0ZU5vcm1hbGl6ZWRQcm9qZWN0UGF0aHMoKTtcclxuICB9XHJcblxyXG4gIHN0YXJ0TGlzdGVuaW5nKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoYXRvbS50ZXh0RWRpdG9ycy5vYnNlcnZlKHRoaXMub2JzZXJ2ZVRleHRFZGl0b3JzLmJpbmQodGhpcykpKTtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKGF0b20ucHJvamVjdC5vbkRpZENoYW5nZVBhdGhzKHRoaXMucHJvamVjdFBhdGhzQ2hhbmdlZC5iaW5kKHRoaXMpKSk7XHJcbiAgICBpZiAoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXMpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXModGhpcy5wcm9qZWN0RmlsZXNDaGFuZ2VkLmJpbmQodGhpcykpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHN0b3BMaXN0ZW5pbmcoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIG9ic2VydmVUZXh0RWRpdG9ycyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IHZvaWQge1xyXG4gICAgLy8gVHJhY2sgZ3JhbW1hciBjaGFuZ2VzIGZvciBvcGVuZWQgZWRpdG9yc1xyXG4gICAgY29uc3QgbGlzdGVuZXIgPSBlZGl0b3Iub2JzZXJ2ZUdyYW1tYXIoZ3JhbW1hciA9PiB0aGlzLl9oYW5kbGVHcmFtbWFyQ2hhbmdlKGVkaXRvcikpO1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiBsaXN0ZW5lci5kaXNwb3NlKCkpKTtcclxuICAgIC8vIFRyeSB0byBzZWUgaWYgZWRpdG9yIGNhbiBoYXZlIExTIGNvbm5lY3RlZCB0byBpdFxyXG4gICAgdGhpcy5faGFuZGxlVGV4dEVkaXRvcihlZGl0b3IpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgX2hhbmRsZVRleHRFZGl0b3IoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICghdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuaGFzKGVkaXRvcikpIHtcclxuICAgICAgLy8gZWRpdG9yIGhhc24ndCBiZWVuIHByb2Nlc3NlZCB5ZXQsIHNvIHByb2Nlc3MgaXQgYnkgYWxsb2NhdGluZyBMUyBmb3IgaXQgaWYgbmVjZXNzYXJ5XHJcbiAgICAgIGNvbnN0IHNlcnZlciA9IGF3YWl0IHRoaXMuZ2V0U2VydmVyKGVkaXRvciwge3Nob3VsZFN0YXJ0OiB0cnVlfSk7XHJcbiAgICAgIGlmIChzZXJ2ZXIgIT0gbnVsbCkge1xyXG4gICAgICAgIC8vIFRoZXJlIExTIGZvciB0aGUgZWRpdG9yIChlaXRoZXIgc3RhcnRlZCBub3cgYW5kIGFscmVhZHkgcnVubmluZylcclxuICAgICAgICB0aGlzLl9lZGl0b3JUb1NlcnZlci5zZXQoZWRpdG9yLCBzZXJ2ZXIpO1xyXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxyXG4gICAgICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2VkaXRvclRvU2VydmVyLmRlbGV0ZShlZGl0b3IpO1xyXG4gICAgICAgICAgICB0aGlzLnN0b3BVbnVzZWRTZXJ2ZXJzKCk7XHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfaGFuZGxlR3JhbW1hckNoYW5nZShlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikge1xyXG4gICAgaWYgKHRoaXMuX3N0YXJ0Rm9yRWRpdG9yKGVkaXRvcikpIHtcclxuICAgICAgLy8gSWYgZWRpdG9yIGlzIGludGVyZXN0aW5nIGZvciBMUyBwcm9jZXNzIHRoZSBlZGl0b3IgZnVydGhlciB0byBhdHRlbXB0IHRvIHN0YXJ0IExTIGlmIG5lZWRlZFxyXG4gICAgICB0aGlzLl9oYW5kbGVUZXh0RWRpdG9yKGVkaXRvcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBFZGl0b3IgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgTFNcclxuICAgICAgY29uc3Qgc2VydmVyID0gdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuZ2V0KGVkaXRvcik7XHJcbiAgICAgIC8vIElmIExTIGlzIHJ1bm5pbmcgZm9yIHRoZSB1bnN1cHBvcnRlZCBlZGl0b3IgdGhlbiBkaXNjb25uZWN0IHRoZSBlZGl0b3IgZnJvbSBMUyBhbmQgc2h1dCBkb3duIExTIGlmIG5lY2Vzc2FyeVxyXG4gICAgICBpZiAoc2VydmVyKSB7XHJcbiAgICAgICAgLy8gTFMgaXMgdXAgZm9yIHVuc3VwcG9ydGVkIHNlcnZlclxyXG4gICAgICAgIGlmIChzZXJ2ZXIuZG9jU3luY0FkYXB0ZXIpIHtcclxuICAgICAgICAgIGNvbnN0IHN5bmNBZGFwdGVyID0gc2VydmVyLmRvY1N5bmNBZGFwdGVyLmdldEVkaXRvclN5bmNBZGFwdGVyKGVkaXRvcik7XHJcbiAgICAgICAgICBpZiAoc3luY0FkYXB0ZXIpIHtcclxuICAgICAgICAgICAgLy8gSW1taXRhdGUgZWRpdG9yIGNsb3NlIHRvIGRpc2Nvbm5lY3QgTFMgZnJvbSB0aGUgZWRpdG9yXHJcbiAgICAgICAgICAgIHN5bmNBZGFwdGVyLmRpZENsb3NlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIFJlbW92ZSBlZGl0b3IgZnJvbSB0aGUgY2FjaGVcclxuICAgICAgICB0aGlzLl9lZGl0b3JUb1NlcnZlci5kZWxldGUoZWRpdG9yKTtcclxuICAgICAgICAvLyBTaHV0IGRvd24gTFMgaWYgaXQncyB1c2VkIGJ5IGFueSBvdGhlciBlZGl0b3JcclxuICAgICAgICB0aGlzLnN0b3BVbnVzZWRTZXJ2ZXJzKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldEFjdGl2ZVNlcnZlcnMoKTogQXJyYXk8QWN0aXZlU2VydmVyPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlU2VydmVycy5zbGljZSgpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0U2VydmVyKFxyXG4gICAgdGV4dEVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxyXG4gICAge3Nob3VsZFN0YXJ0fToge3Nob3VsZFN0YXJ0PzogYm9vbGVhbn0gPSB7c2hvdWxkU3RhcnQ6IGZhbHNlfSxcclxuICApOiBQcm9taXNlPD9BY3RpdmVTZXJ2ZXI+IHtcclxuICAgIGNvbnN0IGZpbmFsUHJvamVjdFBhdGggPSB0aGlzLmRldGVybWluZVByb2plY3RQYXRoKHRleHRFZGl0b3IpO1xyXG4gICAgaWYgKGZpbmFsUHJvamVjdFBhdGggPT0gbnVsbCkge1xyXG4gICAgICAvLyBGaWxlcyBub3QgeWV0IHNhdmVkIGhhdmUgbm8gcGF0aFxyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmb3VuZEFjdGl2ZVNlcnZlciA9IHRoaXMuX2FjdGl2ZVNlcnZlcnMuZmluZChzID0+IGZpbmFsUHJvamVjdFBhdGggPT09IHMucHJvamVjdFBhdGgpO1xyXG4gICAgaWYgKGZvdW5kQWN0aXZlU2VydmVyKSB7XHJcbiAgICAgIHJldHVybiBmb3VuZEFjdGl2ZVNlcnZlcjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdGFydGluZ1Byb21pc2UgPSB0aGlzLl9zdGFydGluZ1NlcnZlclByb21pc2VzLmdldChmaW5hbFByb2plY3RQYXRoKTtcclxuICAgIGlmIChzdGFydGluZ1Byb21pc2UpIHtcclxuICAgICAgcmV0dXJuIHN0YXJ0aW5nUHJvbWlzZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc2hvdWxkU3RhcnQgJiYgdGhpcy5fc3RhcnRGb3JFZGl0b3IodGV4dEVkaXRvcikgPyBhd2FpdCB0aGlzLnN0YXJ0U2VydmVyKGZpbmFsUHJvamVjdFBhdGgpIDogbnVsbDtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0YXJ0U2VydmVyKHByb2plY3RQYXRoOiBzdHJpbmcpOiBQcm9taXNlPEFjdGl2ZVNlcnZlcj4ge1xyXG4gICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBTZXJ2ZXIgc3RhcnRpbmcgXCIke3Byb2plY3RQYXRofVwiYCk7XHJcbiAgICBjb25zdCBzdGFydGluZ1Byb21pc2UgPSB0aGlzLl9zdGFydFNlcnZlcihwcm9qZWN0UGF0aCk7XHJcbiAgICB0aGlzLl9zdGFydGluZ1NlcnZlclByb21pc2VzLnNldChwcm9qZWN0UGF0aCwgc3RhcnRpbmdQcm9taXNlKTtcclxuICAgIGNvbnN0IHN0YXJ0ZWRBY3RpdmVTZXJ2ZXIgPSBhd2FpdCBzdGFydGluZ1Byb21pc2U7XHJcbiAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJzLnB1c2goc3RhcnRlZEFjdGl2ZVNlcnZlcik7XHJcbiAgICB0aGlzLl9zdGFydGluZ1NlcnZlclByb21pc2VzLmRlbGV0ZShwcm9qZWN0UGF0aCk7XHJcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdGFydGVkIFwiJHtwcm9qZWN0UGF0aH1cIiAocGlkICR7c3RhcnRlZEFjdGl2ZVNlcnZlci5wcm9jZXNzLnBpZH0pYCk7XHJcbiAgICByZXR1cm4gc3RhcnRlZEFjdGl2ZVNlcnZlcjtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0b3BVbnVzZWRTZXJ2ZXJzKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgdXNlZFNlcnZlcnMgPSBuZXcgU2V0KHRoaXMuX2VkaXRvclRvU2VydmVyLnZhbHVlcygpKTtcclxuICAgIGNvbnN0IHVudXNlZFNlcnZlcnMgPSB0aGlzLl9hY3RpdmVTZXJ2ZXJzLmZpbHRlcihzID0+ICF1c2VkU2VydmVycy5oYXMocykpO1xyXG4gICAgaWYgKHVudXNlZFNlcnZlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFN0b3BwaW5nICR7dW51c2VkU2VydmVycy5sZW5ndGh9IHVudXNlZCBzZXJ2ZXJzYCk7XHJcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHVudXNlZFNlcnZlcnMubWFwKHMgPT4gdGhpcy5zdG9wU2VydmVyKHMpKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdG9wQWxsU2VydmVycygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMuX2FjdGl2ZVNlcnZlcnMubWFwKHMgPT4gdGhpcy5zdG9wU2VydmVyKHMpKSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdG9wU2VydmVyKHNlcnZlcjogQWN0aXZlU2VydmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdG9wcGluZyBcIiR7c2VydmVyLnByb2plY3RQYXRofVwiYCk7XHJcbiAgICAvLyBJbW1lZGlhdGVseSByZW1vdmUgdGhlIHNlcnZlciB0byBwcmV2ZW50IGZ1cnRoZXIgdXNhZ2UuXHJcbiAgICAvLyBJZiB3ZSByZS1vcGVuIHRoZSBmaWxlIGFmdGVyIHRoaXMgcG9pbnQsIHdlJ2xsIGdldCBhIG5ldyBzZXJ2ZXIuXHJcbiAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJzLnNwbGljZSh0aGlzLl9hY3RpdmVTZXJ2ZXJzLmluZGV4T2Yoc2VydmVyKSwgMSk7XHJcbiAgICB0aGlzLl9zdG9wcGluZ1NlcnZlcnMucHVzaChzZXJ2ZXIpO1xyXG4gICAgc2VydmVyLmRpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG4gICAgYXdhaXQgc2VydmVyLmNvbm5lY3Rpb24uc2h1dGRvd24oKTtcclxuXHJcbiAgICBpZiAoc2VydmVyLmxpbnRlclB1c2hWMiAhPSBudWxsKSB7XHJcbiAgICAgIHNlcnZlci5saW50ZXJQdXNoVjIuZGV0YWNoQWxsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNlcnZlci5zaWduYXR1cmVIZWxwQWRhcHRlciAhPSBudWxsKSB7XHJcbiAgICAgIHNlcnZlci5zaWduYXR1cmVIZWxwQWRhcHRlci5kaXNwb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5leGl0U2VydmVyKHNlcnZlcik7XHJcbiAgICB0aGlzLl9zdG9wcGluZ1NlcnZlcnMuc3BsaWNlKHRoaXMuX3N0b3BwaW5nU2VydmVycy5pbmRleE9mKHNlcnZlciksIDEpO1xyXG4gIH1cclxuXHJcbiAgZXhpdFNlcnZlcihzZXJ2ZXI6IEFjdGl2ZVNlcnZlcik6IHZvaWQge1xyXG4gICAgY29uc3QgcGlkID0gc2VydmVyLnByb2Nlc3MucGlkO1xyXG4gICAgdHJ5IHtcclxuICAgICAgc2VydmVyLmNvbm5lY3Rpb24uZXhpdCgpO1xyXG4gICAgfSBmaW5hbGx5IHtcclxuICAgICAgc2VydmVyLnByb2Nlc3Mua2lsbCgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBTZXJ2ZXIgc3RvcHBlZCBcIiR7c2VydmVyLnByb2plY3RQYXRofVwiIChwaWQgJHtwaWR9KWApO1xyXG4gIH1cclxuXHJcbiAgdGVybWluYXRlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fc3RvcHBpbmdTZXJ2ZXJzLmZvckVhY2goc2VydmVyID0+IHtcclxuICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBTZXJ2ZXIgdGVybWluYXRpbmcgXCIke3NlcnZlci5wcm9qZWN0UGF0aH1cImApO1xyXG4gICAgICB0aGlzLmV4aXRTZXJ2ZXIoc2VydmVyKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZGV0ZXJtaW5lUHJvamVjdFBhdGgodGV4dEVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogP3N0cmluZyB7XHJcbiAgICBjb25zdCBmaWxlUGF0aCA9IHRleHRFZGl0b3IuZ2V0UGF0aCgpO1xyXG4gICAgaWYgKGZpbGVQYXRoID09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5fbm9ybWFsaXplZFByb2plY3RQYXRocy5maW5kKGQgPT4gZmlsZVBhdGguc3RhcnRzV2l0aChkKSk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVOb3JtYWxpemVkUHJvamVjdFBhdGhzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fbm9ybWFsaXplZFByb2plY3RQYXRocyA9IGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLm1hcChkID0+IHRoaXMubm9ybWFsaXplUGF0aChkLmdldFBhdGgoKSkpO1xyXG4gIH1cclxuXHJcbiAgbm9ybWFsaXplUGF0aChwcm9qZWN0UGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiAhcHJvamVjdFBhdGguZW5kc1dpdGgocGF0aC5zZXApID8gcGF0aC5qb2luKHByb2plY3RQYXRoLCBwYXRoLnNlcCkgOiBwcm9qZWN0UGF0aDtcclxuICB9XHJcblxyXG4gIHByb2plY3RQYXRoc0NoYW5nZWQocHJvamVjdFBhdGhzOiBBcnJheTxzdHJpbmc+KTogdm9pZCB7XHJcbiAgICBjb25zdCBwYXRoc1NldCA9IG5ldyBTZXQocHJvamVjdFBhdGhzLm1hcCh0aGlzLm5vcm1hbGl6ZVBhdGgpKTtcclxuICAgIGNvbnN0IHNlcnZlcnNUb1N0b3AgPSB0aGlzLl9hY3RpdmVTZXJ2ZXJzLmZpbHRlcihzID0+ICFwYXRoc1NldC5oYXMocy5wcm9qZWN0UGF0aCkpO1xyXG4gICAgUHJvbWlzZS5hbGwoc2VydmVyc1RvU3RvcC5tYXAocyA9PiB0aGlzLnN0b3BTZXJ2ZXIocykpKTtcclxuICAgIHRoaXMudXBkYXRlTm9ybWFsaXplZFByb2plY3RQYXRocygpO1xyXG4gIH1cclxuXHJcbiAgcHJvamVjdEZpbGVzQ2hhbmdlZChmaWxlRXZlbnRzOiBBcnJheTxhdG9tJFByb2plY3RGaWxlRXZlbnQ+KTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5fYWN0aXZlU2VydmVycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAoY29uc3QgYWN0aXZlU2VydmVyIG9mIHRoaXMuX2FjdGl2ZVNlcnZlcnMpIHtcclxuICAgICAgY29uc3QgY2hhbmdlcyA9IFtdO1xyXG4gICAgICBmb3IgKGNvbnN0IGZpbGVFdmVudCBvZiBmaWxlRXZlbnRzKSB7XHJcbiAgICAgICAgaWYgKGZpbGVFdmVudC5wYXRoLnN0YXJ0c1dpdGgoYWN0aXZlU2VydmVyLnByb2plY3RQYXRoKSkge1xyXG4gICAgICAgICAgY2hhbmdlcy5wdXNoKENvbnZlcnQuYXRvbUZpbGVFdmVudFRvTFNGaWxlRXZlbnRzKGZpbGVFdmVudClbMF0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZmlsZUV2ZW50Lm9sZFBhdGggJiYgZmlsZUV2ZW50Lm9sZFBhdGguc3RhcnRzV2l0aChhY3RpdmVTZXJ2ZXIucHJvamVjdFBhdGgpKSB7XHJcbiAgICAgICAgICBjaGFuZ2VzLnB1c2goQ29udmVydC5hdG9tRmlsZUV2ZW50VG9MU0ZpbGVFdmVudHMoZmlsZUV2ZW50KVsxXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBhY3RpdmVTZXJ2ZXIuY29ubmVjdGlvbi5kaWRDaGFuZ2VXYXRjaGVkRmlsZXMoe2NoYW5nZXN9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=