'use strict';

var cov_1svdwc0r92 = function () {
  var path = '/Users/hansonw/atom-ide-ui/modules/nuclide-commons/symbol-definition-preview.js',
      hash = '260ca4924a6b290b5c49a885d37526865b65e3de',
      global = new Function('return this')(),
      gcv = '__coverage__',
      coverageData = {
    path: '/Users/hansonw/atom-ide-ui/modules/nuclide-commons/symbol-definition-preview.js',
    statementMap: {
      '0': {
        start: {
          line: 24,
          column: 26
        },
        end: {
          line: 24,
          column: 28
        }
      },
      '1': {
        start: {
          line: 25,
          column: 21
        },
        end: {
          line: 25,
          column: 27
        }
      },
      '2': {
        start: {
          line: 26,
          column: 25
        },
        end: {
          line: 26,
          column: 31
        }
      },
      '3': {
        start: {
          line: 28,
          column: 2
        },
        end: {
          line: 28,
          column: 47
        }
      },
      '4': {
        start: {
          line: 39,
          column: 16
        },
        end: {
          line: 39,
          column: 53
        }
      },
      '5': {
        start: {
          line: 40,
          column: 2
        },
        end: {
          line: 42,
          column: 3
        }
      },
      '6': {
        start: {
          line: 41,
          column: 4
        },
        end: {
          line: 41,
          column: 16
        }
      },
      '7': {
        start: {
          line: 45,
          column: 21
        },
        end: {
          line: 45,
          column: 62
        }
      },
      '8': {
        start: {
          line: 48,
          column: 4
        },
        end: {
          line: 48,
          column: 78
        }
      },
      '9': {
        start: {
          line: 49,
          column: 2
        },
        end: {
          line: 51,
          column: 3
        }
      },
      '10': {
        start: {
          line: 50,
          column: 4
        },
        end: {
          line: 50,
          column: 79
        }
      },
      '11': {
        start: {
          line: 53,
          column: 19
        },
        end: {
          line: 53,
          column: 46
        }
      },
      '12': {
        start: {
          line: 54,
          column: 16
        },
        end: {
          line: 54,
          column: 36
        }
      },
      '13': {
        start: {
          line: 56,
          column: 16
        },
        end: {
          line: 56,
          column: 39
        }
      },
      '14': {
        start: {
          line: 57,
          column: 29
        },
        end: {
          line: 57,
          column: 57
        }
      },
      '15': {
        start: {
          line: 59,
          column: 17
        },
        end: {
          line: 59,
          column: 19
        }
      },
      '16': {
        start: {
          line: 60,
          column: 2
        },
        end: {
          line: 98,
          column: 3
        }
      },
      '17': {
        start: {
          line: 69,
          column: 17
        },
        end: {
          line: 69,
          column: 25
        }
      },
      '18': {
        start: {
          line: 70,
          column: 24
        },
        end: {
          line: 70,
          column: 44
        }
      },
      '19': {
        start: {
          line: 71,
          column: 4
        },
        end: {
          line: 71,
          column: 50
        }
      },
      '20': {
        start: {
          line: 72,
          column: 4
        },
        end: {
          line: 72,
          column: 52
        }
      },
      '21': {
        start: {
          line: 73,
          column: 4
        },
        end: {
          line: 73,
          column: 50
        }
      },
      '22': {
        start: {
          line: 74,
          column: 4
        },
        end: {
          line: 74,
          column: 52
        }
      },
      '23': {
        start: {
          line: 76,
          column: 4
        },
        end: {
          line: 76,
          column: 72
        }
      },
      '24': {
        start: {
          line: 79,
          column: 4
        },
        end: {
          line: 97,
          column: 5
        }
      },
      '25': {
        start: {
          line: 81,
          column: 6
        },
        end: {
          line: 96,
          column: 7
        }
      },
      '26': {
        start: {
          line: 83,
          column: 8
        },
        end: {
          line: 83,
          column: 14
        }
      },
      '27': {
        start: {
          line: 84,
          column: 13
        },
        end: {
          line: 96,
          column: 7
        }
      },
      '28': {
        start: {
          line: 86,
          column: 8
        },
        end: {
          line: 86,
          column: 14
        }
      },
      '29': {
        start: {
          line: 87,
          column: 13
        },
        end: {
          line: 96,
          column: 7
        }
      },
      '30': {
        start: {
          line: 95,
          column: 8
        },
        end: {
          line: 95,
          column: 14
        }
      },
      '31': {
        start: {
          line: 100,
          column: 2
        },
        end: {
          line: 100,
          column: 63
        }
      }
    },
    fnMap: {
      '0': {
        name: 'getIndentLevel',
        decl: {
          start: {
            line: 27,
            column: 9
          },
          end: {
            line: 27,
            column: 23
          }
        },
        loc: {
          start: {
            line: 27,
            column: 38
          },
          end: {
            line: 29,
            column: 1
          }
        },
        line: 27
      },
      '1': {
        name: 'getDefinitionPreview',
        decl: {
          start: {
            line: 31,
            column: 22
          },
          end: {
            line: 31,
            column: 42
          }
        },
        loc: {
          start: {
            line: 37,
            column: 3
          },
          end: {
            line: 101,
            column: 1
          }
        },
        line: 37
      }
    },
    branchMap: {
      '0': {
        loc: {
          start: {
            line: 40,
            column: 2
          },
          end: {
            line: 42,
            column: 3
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 40,
            column: 2
          },
          end: {
            line: 42,
            column: 3
          }
        }, {
          start: {
            line: 40,
            column: 2
          },
          end: {
            line: 42,
            column: 3
          }
        }],
        line: 40
      },
      '1': {
        loc: {
          start: {
            line: 48,
            column: 4
          },
          end: {
            line: 48,
            column: 78
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 48,
            column: 4
          },
          end: {
            line: 48,
            column: 62
          }
        }, {
          start: {
            line: 48,
            column: 66
          },
          end: {
            line: 48,
            column: 78
          }
        }],
        line: 48
      },
      '2': {
        loc: {
          start: {
            line: 49,
            column: 2
          },
          end: {
            line: 51,
            column: 3
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 49,
            column: 2
          },
          end: {
            line: 51,
            column: 3
          }
        }, {
          start: {
            line: 49,
            column: 2
          },
          end: {
            line: 51,
            column: 3
          }
        }],
        line: 49
      },
      '3': {
        loc: {
          start: {
            line: 66,
            column: 4
          },
          end: {
            line: 66,
            column: 53
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 66,
            column: 4
          },
          end: {
            line: 66,
            column: 33
          }
        }, {
          start: {
            line: 66,
            column: 37
          },
          end: {
            line: 66,
            column: 53
          }
        }],
        line: 66
      },
      '4': {
        loc: {
          start: {
            line: 79,
            column: 4
          },
          end: {
            line: 97,
            column: 5
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 79,
            column: 4
          },
          end: {
            line: 97,
            column: 5
          }
        }, {
          start: {
            line: 79,
            column: 4
          },
          end: {
            line: 97,
            column: 5
          }
        }],
        line: 79
      },
      '5': {
        loc: {
          start: {
            line: 81,
            column: 6
          },
          end: {
            line: 96,
            column: 7
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 81,
            column: 6
          },
          end: {
            line: 96,
            column: 7
          }
        }, {
          start: {
            line: 81,
            column: 6
          },
          end: {
            line: 96,
            column: 7
          }
        }],
        line: 81
      },
      '6': {
        loc: {
          start: {
            line: 81,
            column: 10
          },
          end: {
            line: 81,
            column: 67
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 81,
            column: 10
          },
          end: {
            line: 81,
            column: 28
          }
        }, {
          start: {
            line: 81,
            column: 32
          },
          end: {
            line: 81,
            column: 67
          }
        }],
        line: 81
      },
      '7': {
        loc: {
          start: {
            line: 84,
            column: 13
          },
          end: {
            line: 96,
            column: 7
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 84,
            column: 13
          },
          end: {
            line: 96,
            column: 7
          }
        }, {
          start: {
            line: 84,
            column: 13
          },
          end: {
            line: 96,
            column: 7
          }
        }],
        line: 84
      },
      '8': {
        loc: {
          start: {
            line: 87,
            column: 13
          },
          end: {
            line: 96,
            column: 7
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 87,
            column: 13
          },
          end: {
            line: 96,
            column: 7
          }
        }, {
          start: {
            line: 87,
            column: 13
          },
          end: {
            line: 96,
            column: 7
          }
        }],
        line: 87
      },
      '9': {
        loc: {
          start: {
            line: 89,
            column: 8
          },
          end: {
            line: 93,
            column: 43
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 89,
            column: 8
          },
          end: {
            line: 89,
            column: 33
          }
        }, {
          start: {
            line: 91,
            column: 8
          },
          end: {
            line: 91,
            column: 43
          }
        }, {
          start: {
            line: 93,
            column: 8
          },
          end: {
            line: 93,
            column: 43
          }
        }],
        line: 89
      }
    },
    s: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0,
      '8': 0,
      '9': 0,
      '10': 0,
      '11': 0,
      '12': 0,
      '13': 0,
      '14': 0,
      '15': 0,
      '16': 0,
      '17': 0,
      '18': 0,
      '19': 0,
      '20': 0,
      '21': 0,
      '22': 0,
      '23': 0,
      '24': 0,
      '25': 0,
      '26': 0,
      '27': 0,
      '28': 0,
      '29': 0,
      '30': 0,
      '31': 0
    },
    f: {
      '0': 0,
      '1': 0
    },
    b: {
      '0': [0, 0],
      '1': [0, 0],
      '2': [0, 0],
      '3': [0, 0],
      '4': [0, 0],
      '5': [0, 0],
      '6': [0, 0],
      '7': [0, 0],
      '8': [0, 0],
      '9': [0, 0, 0]
    },
    _coverageSchema: '332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'
  },
      coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  coverageData.hash = hash;
  return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getDefinitionPreview = undefined;

var _asyncToGenerator = _interopRequireDefault(require('async-to-generator'));

let getDefinitionPreview = exports.getDefinitionPreview = (() => {
  var _ref = (0, _asyncToGenerator.default)(function* (definition) {
    cov_1svdwc0r92.f[1]++;

    // ensure filesize not too big before reading in whole file
    const stats = (cov_1svdwc0r92.s[4]++, yield (_fsPromise || _load_fsPromise()).default.stat(definition.path));
    cov_1svdwc0r92.s[5]++;
    if (stats.size > MAX_FILESIZE) {
      cov_1svdwc0r92.b[0][0]++;
      cov_1svdwc0r92.s[6]++;

      return null;
    } else {
      cov_1svdwc0r92.b[0][1]++;
    }

    // if file is image, return base-64 encoded contents
    const fileBuffer = (cov_1svdwc0r92.s[7]++, yield (_fsPromise || _load_fsPromise()).default.readFile(definition.path));

    const mime = (cov_1svdwc0r92.s[8]++, (cov_1svdwc0r92.b[1][0]++, (_mimeTypes || _load_mimeTypes()).default.contentType((_nuclideUri || _load_nuclideUri()).default.extname(definition.path))) || (cov_1svdwc0r92.b[1][1]++, 'text/plain'));
    cov_1svdwc0r92.s[9]++;
    if (mime.startsWith('image/')) {
      cov_1svdwc0r92.b[2][0]++;
      cov_1svdwc0r92.s[10]++;

      return { mime, contents: fileBuffer.toString('base64'), encoding: 'base64' };
    } else {
      cov_1svdwc0r92.b[2][1]++;
    }

    const contents = (cov_1svdwc0r92.s[11]++, fileBuffer.toString('utf8'));
    const lines = (cov_1svdwc0r92.s[12]++, contents.split('\n'));

    const start = (cov_1svdwc0r92.s[13]++, definition.position.row);
    const initialIndentLevel = (cov_1svdwc0r92.s[14]++, getIndentLevel(lines[start]));

    const buffer = (cov_1svdwc0r92.s[15]++, []);
    cov_1svdwc0r92.s[16]++;
    for (let i = start, openParenCount = 0, closedParenCount = 0, openCurlyCount = 0, closedCurlyCount = 0; (cov_1svdwc0r92.b[3][0]++, i < start + MAX_PREVIEW_LINES) && (cov_1svdwc0r92.b[3][1]++, i < lines.length); i++) {
      const line = (cov_1svdwc0r92.s[17]++, lines[i]);
      const indentLevel = (cov_1svdwc0r92.s[18]++, getIndentLevel(line));
      cov_1svdwc0r92.s[19]++;
      openParenCount += (0, (_string || _load_string()).countOccurrences)(line, '(');
      cov_1svdwc0r92.s[20]++;
      closedParenCount += (0, (_string || _load_string()).countOccurrences)(line, ')');
      cov_1svdwc0r92.s[21]++;
      openCurlyCount += (0, (_string || _load_string()).countOccurrences)(line, '{');
      cov_1svdwc0r92.s[22]++;
      closedCurlyCount += (0, (_string || _load_string()).countOccurrences)(line, '}');

      cov_1svdwc0r92.s[23]++;
      buffer.push(line.substr(Math.min(indentLevel, initialIndentLevel))); // dedent

      // heuristic for the end of a function signature:
      cov_1svdwc0r92.s[24]++;
      if (indentLevel <= initialIndentLevel) {
        cov_1svdwc0r92.b[4][0]++;
        cov_1svdwc0r92.s[25]++;

        // we've returned back to the original indentation level
        if ((cov_1svdwc0r92.b[6][0]++, openParenCount > 0) && (cov_1svdwc0r92.b[6][1]++, openParenCount === closedParenCount)) {
          cov_1svdwc0r92.b[5][0]++;
          cov_1svdwc0r92.s[26]++;

          // if we're in a fn definition, make sure we have balanced pairs of parens
          break;
        } else {
            cov_1svdwc0r92.b[5][1]++;
            cov_1svdwc0r92.s[27]++;
            if (line.trim().endsWith(';')) {
              cov_1svdwc0r92.b[7][0]++;
              cov_1svdwc0r92.s[28]++;

              // c-style statement ending
              break;
            } else {
                cov_1svdwc0r92.b[7][1]++;
                cov_1svdwc0r92.s[29]++;
                if (
                // end of a property definition
                (cov_1svdwc0r92.b[9][0]++, line.trim().endsWith(',')) && (cov_1svdwc0r92.b[9][1]++,
                // including complex types as values
                openCurlyCount === closedCurlyCount) && (cov_1svdwc0r92.b[9][2]++,
                // but still not before function signatures are closed
                openParenCount === closedParenCount)) {
                  cov_1svdwc0r92.b[8][0]++;
                  cov_1svdwc0r92.s[30]++;

                  break;
                } else {
                  cov_1svdwc0r92.b[8][1]++;
                }
              }
          }
      } else {
        cov_1svdwc0r92.b[4][1]++;
      }
    }

    cov_1svdwc0r92.s[31]++;
    return { mime, contents: buffer.join('\n'), encoding: 'utf8' };
  });

  return function getDefinitionPreview(_x) {
    return _ref.apply(this, arguments);
  };
})();

var _mimeTypes;

function _load_mimeTypes() {
  return _mimeTypes = _interopRequireDefault(require('mime-types'));
}

var _fsPromise;

function _load_fsPromise() {
  return _fsPromise = _interopRequireDefault(require('./fsPromise'));
}

var _string;

function _load_string() {
  return _string = require('./string');
}

var _nuclideUri;

function _load_nuclideUri() {
  return _nuclideUri = _interopRequireDefault(require('./nuclideUri'));
}

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const MAX_PREVIEW_LINES = (cov_1svdwc0r92.s[0]++, 10); /**
                                                        * Copyright (c) 2017-present, Facebook, Inc.
                                                        * All rights reserved.
                                                        *
                                                        * This source code is licensed under the BSD-style license found in the
                                                        * LICENSE file in the root directory of this source tree. An additional grant
                                                        * of patent rights can be found in the PATENTS file in the same directory.
                                                        *
                                                        * 
                                                        * @format
                                                        */

const MAX_FILESIZE = (cov_1svdwc0r92.s[1]++, 100000);
const WHITESPACE_REGEX = (cov_1svdwc0r92.s[2]++, /^\s*/);
function getIndentLevel(line) {
  cov_1svdwc0r92.f[0]++;
  cov_1svdwc0r92.s[3]++;

  return WHITESPACE_REGEX.exec(line)[0].length;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN5bWJvbC1kZWZpbml0aW9uLXByZXZpZXcuanMiXSwibmFtZXMiOlsiZGVmaW5pdGlvbiIsInN0YXRzIiwic3RhdCIsInBhdGgiLCJzaXplIiwiTUFYX0ZJTEVTSVpFIiwiZmlsZUJ1ZmZlciIsInJlYWRGaWxlIiwibWltZSIsImNvbnRlbnRUeXBlIiwiZXh0bmFtZSIsInN0YXJ0c1dpdGgiLCJjb250ZW50cyIsInRvU3RyaW5nIiwiZW5jb2RpbmciLCJsaW5lcyIsInNwbGl0Iiwic3RhcnQiLCJwb3NpdGlvbiIsInJvdyIsImluaXRpYWxJbmRlbnRMZXZlbCIsImdldEluZGVudExldmVsIiwiYnVmZmVyIiwiaSIsIm9wZW5QYXJlbkNvdW50IiwiY2xvc2VkUGFyZW5Db3VudCIsIm9wZW5DdXJseUNvdW50IiwiY2xvc2VkQ3VybHlDb3VudCIsIk1BWF9QUkVWSUVXX0xJTkVTIiwibGVuZ3RoIiwibGluZSIsImluZGVudExldmVsIiwicHVzaCIsInN1YnN0ciIsIk1hdGgiLCJtaW4iLCJ0cmltIiwiZW5kc1dpdGgiLCJqb2luIiwiZ2V0RGVmaW5pdGlvblByZXZpZXciLCJXSElURVNQQUNFX1JFR0VYIiwiZXhlYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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O0FBQUE7QUFBQTs7QUFDckM7QUFDQSxZQUFJLDRDQUFpQixDQUFqQixnQ0FBc0JJLG1CQUFtQkMsZ0JBQXpDLENBQUosRUFBK0Q7QUFBQTtBQUFBOztBQUM3RDtBQUNBO0FBQ0QsU0FIRCxNQUdPO0FBQUE7QUFBQTtBQUFBLGdCQUFJSyxLQUFLTSxJQUFMLEdBQVlDLFFBQVosQ0FBcUIsR0FBckIsQ0FBSixFQUErQjtBQUFBO0FBQUE7O0FBQ3BDO0FBQ0E7QUFDRCxhQUhNLE1BR0E7QUFBQTtBQUFBO0FBQUE7QUFDTDtBQUNBLGdEQUFLRCxJQUFMLEdBQVlDLFFBQVosQ0FBcUIsR0FBckI7QUFDQTtBQUNBWCxtQ0FBbUJDLGdCQUZuQjtBQUdBO0FBQ0FILG1DQUFtQkMsZ0JBSm5CLENBRkssRUFPTDtBQUFBO0FBQUE7O0FBQ0E7QUFDRCxpQkFUTTtBQUFBO0FBQUE7QUFTTjtBQUFBO0FBQ0YsT0FsQkQ7QUFBQTtBQUFBO0FBbUJEOztBQTdEQTtBQStERCxXQUFPLEVBQUNqQixJQUFELEVBQU9JLFVBQVVVLE9BQU9nQixJQUFQLENBQVksSUFBWixDQUFqQixFQUFvQ3hCLFVBQVUsTUFBOUMsRUFBUDtBQUNELEc7O2tCQXRFcUJ5QixvQjs7Ozs7OztBQWpCdEI7QUFBQTtBQUFBOzs7O0FBQ0E7QUFBQTtBQUFBOzs7O0FBQ0E7QUFBQTtBQUFBOzs7O0FBQ0E7QUFBQTtBQUFBOzs7O0FBT0EsTUFBTVgsNENBQW9CLEVBQXBCLENBQU4sQyxDQXZCQTs7Ozs7Ozs7Ozs7O0FBd0JBLE1BQU12Qix1Q0FBZSxNQUFmLENBQU47QUFDQSxNQUFNbUMsMkNBQW1CLE1BQW5CLENBQU47QUFDQSxTQUFTbkIsY0FBVCxDQUF3QlMsSUFBeEIsRUFBc0M7QUFBQTtBQUFBOztBQUNwQyxTQUFPVSxpQkFBaUJDLElBQWpCLENBQXNCWCxJQUF0QixFQUE0QixDQUE1QixFQUErQkQsTUFBdEM7QUFDRCIsImZpbGUiOiJzeW1ib2wtZGVmaW5pdGlvbi1wcmV2aWV3LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuaW1wb3J0IHR5cGUge051Y2xpZGVVcml9IGZyb20gJy4vbnVjbGlkZVVyaSc7XG5pbXBvcnQgbWltZVR5cGVzIGZyb20gJ21pbWUtdHlwZXMnO1xuaW1wb3J0IGZzUHJvbWlzZSBmcm9tICcuL2ZzUHJvbWlzZSc7XG5pbXBvcnQge2NvdW50T2NjdXJyZW5jZXN9IGZyb20gJy4vc3RyaW5nJztcbmltcG9ydCBudWNsaWRlVXJpIGZyb20gJy4vbnVjbGlkZVVyaSc7XG5cbnR5cGUgRGVmaW5pdGlvbiA9IHtcbiAgcGF0aDogTnVjbGlkZVVyaSxcbiAgcG9zaXRpb246IGF0b20kUG9pbnQsXG59O1xuXG5jb25zdCBNQVhfUFJFVklFV19MSU5FUyA9IDEwO1xuY29uc3QgTUFYX0ZJTEVTSVpFID0gMTAwMDAwO1xuY29uc3QgV0hJVEVTUEFDRV9SRUdFWCA9IC9eXFxzKi87XG5mdW5jdGlvbiBnZXRJbmRlbnRMZXZlbChsaW5lOiBzdHJpbmcpIHtcbiAgcmV0dXJuIFdISVRFU1BBQ0VfUkVHRVguZXhlYyhsaW5lKVswXS5sZW5ndGg7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREZWZpbml0aW9uUHJldmlldyhcbiAgZGVmaW5pdGlvbjogRGVmaW5pdGlvbixcbik6IFByb21pc2U8P3tcbiAgbWltZTogc3RyaW5nLFxuICBjb250ZW50czogc3RyaW5nLFxuICBlbmNvZGluZzogc3RyaW5nLFxufT4ge1xuICAvLyBlbnN1cmUgZmlsZXNpemUgbm90IHRvbyBiaWcgYmVmb3JlIHJlYWRpbmcgaW4gd2hvbGUgZmlsZVxuICBjb25zdCBzdGF0cyA9IGF3YWl0IGZzUHJvbWlzZS5zdGF0KGRlZmluaXRpb24ucGF0aCk7XG4gIGlmIChzdGF0cy5zaXplID4gTUFYX0ZJTEVTSVpFKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvLyBpZiBmaWxlIGlzIGltYWdlLCByZXR1cm4gYmFzZS02NCBlbmNvZGVkIGNvbnRlbnRzXG4gIGNvbnN0IGZpbGVCdWZmZXIgPSBhd2FpdCBmc1Byb21pc2UucmVhZEZpbGUoZGVmaW5pdGlvbi5wYXRoKTtcblxuICBjb25zdCBtaW1lID1cbiAgICBtaW1lVHlwZXMuY29udGVudFR5cGUobnVjbGlkZVVyaS5leHRuYW1lKGRlZmluaXRpb24ucGF0aCkpIHx8ICd0ZXh0L3BsYWluJztcbiAgaWYgKG1pbWUuc3RhcnRzV2l0aCgnaW1hZ2UvJykpIHtcbiAgICByZXR1cm4ge21pbWUsIGNvbnRlbnRzOiBmaWxlQnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKSwgZW5jb2Rpbmc6ICdiYXNlNjQnfTtcbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnRzID0gZmlsZUJ1ZmZlci50b1N0cmluZygndXRmOCcpO1xuICBjb25zdCBsaW5lcyA9IGNvbnRlbnRzLnNwbGl0KCdcXG4nKTtcblxuICBjb25zdCBzdGFydCA9IGRlZmluaXRpb24ucG9zaXRpb24ucm93O1xuICBjb25zdCBpbml0aWFsSW5kZW50TGV2ZWwgPSBnZXRJbmRlbnRMZXZlbChsaW5lc1tzdGFydF0pO1xuXG4gIGNvbnN0IGJ1ZmZlciA9IFtdO1xuICBmb3IgKFxuICAgIGxldCBpID0gc3RhcnQsXG4gICAgICBvcGVuUGFyZW5Db3VudCA9IDAsXG4gICAgICBjbG9zZWRQYXJlbkNvdW50ID0gMCxcbiAgICAgIG9wZW5DdXJseUNvdW50ID0gMCxcbiAgICAgIGNsb3NlZEN1cmx5Q291bnQgPSAwO1xuICAgIGkgPCBzdGFydCArIE1BWF9QUkVWSUVXX0xJTkVTICYmIGkgPCBsaW5lcy5sZW5ndGg7XG4gICAgaSsrXG4gICkge1xuICAgIGNvbnN0IGxpbmUgPSBsaW5lc1tpXTtcbiAgICBjb25zdCBpbmRlbnRMZXZlbCA9IGdldEluZGVudExldmVsKGxpbmUpO1xuICAgIG9wZW5QYXJlbkNvdW50ICs9IGNvdW50T2NjdXJyZW5jZXMobGluZSwgJygnKTtcbiAgICBjbG9zZWRQYXJlbkNvdW50ICs9IGNvdW50T2NjdXJyZW5jZXMobGluZSwgJyknKTtcbiAgICBvcGVuQ3VybHlDb3VudCArPSBjb3VudE9jY3VycmVuY2VzKGxpbmUsICd7Jyk7XG4gICAgY2xvc2VkQ3VybHlDb3VudCArPSBjb3VudE9jY3VycmVuY2VzKGxpbmUsICd9Jyk7XG5cbiAgICBidWZmZXIucHVzaChsaW5lLnN1YnN0cihNYXRoLm1pbihpbmRlbnRMZXZlbCwgaW5pdGlhbEluZGVudExldmVsKSkpOyAvLyBkZWRlbnRcblxuICAgIC8vIGhldXJpc3RpYyBmb3IgdGhlIGVuZCBvZiBhIGZ1bmN0aW9uIHNpZ25hdHVyZTpcbiAgICBpZiAoaW5kZW50TGV2ZWwgPD0gaW5pdGlhbEluZGVudExldmVsKSB7XG4gICAgICAvLyB3ZSd2ZSByZXR1cm5lZCBiYWNrIHRvIHRoZSBvcmlnaW5hbCBpbmRlbnRhdGlvbiBsZXZlbFxuICAgICAgaWYgKG9wZW5QYXJlbkNvdW50ID4gMCAmJiBvcGVuUGFyZW5Db3VudCA9PT0gY2xvc2VkUGFyZW5Db3VudCkge1xuICAgICAgICAvLyBpZiB3ZSdyZSBpbiBhIGZuIGRlZmluaXRpb24sIG1ha2Ugc3VyZSB3ZSBoYXZlIGJhbGFuY2VkIHBhaXJzIG9mIHBhcmVuc1xuICAgICAgICBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAobGluZS50cmltKCkuZW5kc1dpdGgoJzsnKSkge1xuICAgICAgICAvLyBjLXN0eWxlIHN0YXRlbWVudCBlbmRpbmdcbiAgICAgICAgYnJlYWs7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAvLyBlbmQgb2YgYSBwcm9wZXJ0eSBkZWZpbml0aW9uXG4gICAgICAgIGxpbmUudHJpbSgpLmVuZHNXaXRoKCcsJykgJiZcbiAgICAgICAgLy8gaW5jbHVkaW5nIGNvbXBsZXggdHlwZXMgYXMgdmFsdWVzXG4gICAgICAgIG9wZW5DdXJseUNvdW50ID09PSBjbG9zZWRDdXJseUNvdW50ICYmXG4gICAgICAgIC8vIGJ1dCBzdGlsbCBub3QgYmVmb3JlIGZ1bmN0aW9uIHNpZ25hdHVyZXMgYXJlIGNsb3NlZFxuICAgICAgICBvcGVuUGFyZW5Db3VudCA9PT0gY2xvc2VkUGFyZW5Db3VudFxuICAgICAgKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7bWltZSwgY29udGVudHM6IGJ1ZmZlci5qb2luKCdcXG4nKSwgZW5jb2Rpbmc6ICd1dGY4J307XG59XG4iXX0=